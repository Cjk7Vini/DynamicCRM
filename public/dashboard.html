<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversie Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root { 
      --bg: linear-gradient(135deg, #1e40af 0%, #0891b2 100%);
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --primary: #3b82f6;
      --purple: #8b5cf6;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      background: var(--card);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
    }
    
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      color: var(--text);
      font-weight: 700;
    }
    
    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: end;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    button {
      padding: 10px 24px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    
    button:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
    }
    
    button.secondary {
      background: var(--success);
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    
    button.secondary:hover {
      background: #059669;
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .metric-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    
    .metric-label {
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .metric-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .metric-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1;
    }
    
    .metric-change {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .metric-change.positive { color: var(--success); }
    .metric-change.negative { color: var(--danger); }
    
    .chart-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text);
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    .funnel-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }
    
    .funnel-steps {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }
    
    .funnel-step {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .funnel-bar-container {
      flex: 1;
      height: 50px;
      background: var(--border);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .funnel-bar {
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 16px;
      color: white;
      font-weight: 600;
      transition: width 0.5s ease;
    }
    
    .funnel-label {
      min-width: 140px;
      font-weight: 600;
      color: var(--text);
    }
    
    .funnel-value {
      min-width: 80px;
      text-align: right;
      font-weight: 700;
      font-size: 18px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
      font-size: 16px;
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-top: 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 1024px) {
      .chart-section {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 640px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Conversie Dashboard</h1>
      <div class="controls">
        <div class="control-group">
          <label for="practice">Praktijk Code</label>
          <input type="text" id="practice" placeholder="K9X3QY" value="" />
        </div>
        <div class="control-group">
          <label for="from">Van</label>
          <input type="date" id="from" />
        </div>
        <div class="control-group">
          <label for="to">Tot</label>
          <input type="date" id="to" />
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="btnLoad">Laden</button>
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="btnExport" class="secondary" style="display:none;">Exporteer Rapportage</button>
        </div>
      </div>
    </header>

    <div id="loading" class="loading" style="display: none;">
      Dashboard wordt geladen
    </div>

    <div id="content" style="display: none;">
      <!-- Metric Cards -->
      <div class="dashboard-grid">
        <div class="metric-card">
          <div class="metric-header">
            <div>
              <div class="metric-label">Clicks</div>
            </div>
            <div class="metric-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--primary);">CL</div>
          </div>
          <div class="metric-value" id="total-clicks">0</div>
          <div class="metric-change positive">
            <span>↗</span>
            <span id="clicks-change">vs. vorige maand</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div>
              <div class="metric-label">Leads</div>
            </div>
            <div class="metric-icon" style="background: rgba(139, 92, 246, 0.1); color: var(--purple);">LD</div>
          </div>
          <div class="metric-value" id="total-leads">0</div>
          <div class="metric-change positive">
            <span>↗</span>
            <span id="leads-change">Click → Lead rate</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div>
              <div class="metric-label">Afspraken</div>
            </div>
            <div class="metric-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">AP</div>
          </div>
          <div class="metric-value" id="total-appointments">0</div>
          <div class="metric-change positive">
            <span>↗</span>
            <span id="appt-change">Lead → Afspraak rate</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div>
              <div class="metric-label">Registraties</div>
            </div>
            <div class="metric-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success);">RG</div>
          </div>
          <div class="metric-value" id="total-registered">0</div>
          <div class="metric-change positive">
            <span>↗</span>
            <span id="reg-change">Overall conversie</span>
          </div>
        </div>
      </div>

      <!-- Conversion Funnel -->
      <div class="funnel-card">
        <h2 class="chart-title">Conversie Funnel</h2>
        <div class="funnel-steps">
          <div class="funnel-step">
            <div class="funnel-label">Clicks</div>
            <div class="funnel-bar-container">
              <div class="funnel-bar" id="bar-clicks" style="background: var(--primary); width: 100%;">
                <span id="bar-clicks-text">0</span>
              </div>
            </div>
            <div class="funnel-value" id="val-clicks">0</div>
          </div>
          
          <div class="funnel-step">
            <div class="funnel-label">Leads</div>
            <div class="funnel-bar-container">
              <div class="funnel-bar" id="bar-leads" style="background: var(--purple); width: 0%;">
                <span id="bar-leads-text">0%</span>
              </div>
            </div>
            <div class="funnel-value" id="val-leads">0</div>
          </div>
          
          <div class="funnel-step">
            <div class="funnel-label">Afspraken</div>
            <div class="funnel-bar-container">
              <div class="funnel-bar" id="bar-appt" style="background: var(--warning); width: 0%;">
                <span id="bar-appt-text">0%</span>
              </div>
            </div>
            <div class="funnel-value" id="val-appt">0</div>
          </div>
          
          <div class="funnel-step">
            <div class="funnel-label">Registraties</div>
            <div class="funnel-bar-container">
              <div class="funnel-bar" id="bar-reg" style="background: var(--success); width: 0%;">
                <span id="bar-reg-text">0%</span>
              </div>
            </div>
            <div class="funnel-value" id="val-reg">0</div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="chart-section">
        <div class="chart-card">
          <h2 class="chart-title">Conversie Trend (Tijdlijn)</h2>
          <div class="chart-container">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <h2 class="chart-title">Conversie Percentages</h2>
          <div class="chart-container">
            <canvas id="conversionChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize date inputs to last 30 days
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('from').valueAsDate = thirtyDaysAgo;
    document.getElementById('to').valueAsDate = today;
    
    let timelineChart = null;
    let conversionChart = null;
    
    async function loadDashboard() {
      const practice = document.getElementById('practice').value;
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      
      if (!practice || !from || !to) {
        alert('Vul alle velden in (Praktijk Code, Van en Tot datum)');
        return;
      }
      
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
      
      try {
        // Fetch metrics
        const metricsRes = await fetch(`/api/metrics?practice=${practice}&from=${from}&to=${to}`);
        const metrics = await metricsRes.json();
        
        // Fetch series data
        const seriesRes = await fetch(`/api/series?practice=${practice}&from=${from}&to=${to}`);
        const series = await seriesRes.json();
        
        // Store data for export
        currentData = { metrics, series };
        
        updateMetrics(metrics);
        updateCharts(series);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('btnExport').style.display = 'inline-block';
      } catch (err) {
        console.error(err);
        alert('Fout bij laden van dashboard');
        document.getElementById('loading').style.display = 'none';
      }
    }
    
    function updateMetrics(data) {
      const { totals, funnel } = data;
      
      // Update metric cards
      document.getElementById('total-clicks').textContent = totals.clicked || 0;
      document.getElementById('total-leads').textContent = totals.lead_submitted || 0;
      document.getElementById('total-appointments').textContent = totals.appointment_booked || 0;
      document.getElementById('total-registered').textContent = totals.registered || 0;
      
      // Update percentages
      document.getElementById('clicks-change').textContent = `100%`;
      document.getElementById('leads-change').textContent = `${funnel.click_to_lead}% conversie`;
      document.getElementById('appt-change').textContent = `${funnel.lead_to_appt}% conversie`;
      document.getElementById('reg-change').textContent = `${funnel.click_to_reg}% totaal`;
      
      // Update funnel bars
      const maxVal = totals.clicked || 1;
      
      updateFunnelBar('clicks', totals.clicked, 100, maxVal);
      updateFunnelBar('leads', totals.lead_submitted, funnel.click_to_lead, maxVal);
      updateFunnelBar('appt', totals.appointment_booked, funnel.lead_to_appt * funnel.click_to_lead / 100, maxVal);
      updateFunnelBar('reg', totals.registered, funnel.click_to_reg, maxVal);
    }
    
    function updateFunnelBar(type, value, percentage, maxVal) {
      const width = (value / maxVal) * 100;
      document.getElementById(`bar-${type}`).style.width = width + '%';
      document.getElementById(`bar-${type}-text`).textContent = Math.round(percentage) + '%';
      document.getElementById(`val-${type}`).textContent = value;
    }
    
    function updateCharts(data) {
      const { rows } = data;
      
      // Group by day
      const days = {};
      rows.forEach(r => {
        if (!days[r.day]) days[r.day] = { clicked: 0, lead_submitted: 0, appointment_booked: 0, registered: 0 };
        days[r.day][r.event_type] = r.count;
      });
      
      const labels = Object.keys(days).sort();
      const clicksData = labels.map(d => days[d].clicked);
      const leadsData = labels.map(d => days[d].lead_submitted);
      const apptsData = labels.map(d => days[d].appointment_booked);
      const regsData = labels.map(d => days[d].registered);
      
      // Timeline chart
      if (timelineChart) timelineChart.destroy();
      const ctx1 = document.getElementById('timelineChart').getContext('2d');
      timelineChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: labels.map(d => new Date(d).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' })),
          datasets: [
            { label: 'Clicks', data: clicksData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4 },
            { label: 'Leads', data: leadsData, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.4 },
            { label: 'Afspraken', data: apptsData, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', tension: 0.4 },
            { label: 'Registraties', data: regsData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } }
        }
      });
      
      // Conversion doughnut chart
      if (conversionChart) conversionChart.destroy();
      const ctx2 = document.getElementById('conversionChart').getContext('2d');
      const totalClicks = clicksData.reduce((a,b) => a+b, 0);
      const totalLeads = leadsData.reduce((a,b) => a+b, 0);
      const totalAppts = apptsData.reduce((a,b) => a+b, 0);
      const totalRegs = regsData.reduce((a,b) => a+b, 0);
      
      conversionChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Registraties', 'Afspraken', 'Leads', 'Clicks'],
          datasets: [{
            data: [totalRegs, totalAppts - totalRegs, totalLeads - totalAppts, totalClicks - totalLeads],
            backgroundColor: ['#10b981', '#f59e0b', '#8b5cf6', '#3b82f6']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }
    
    document.getElementById('btnLoad').addEventListener('click', loadDashboard);
    
    document.getElementById('btnExport').addEventListener('click', exportReport);
    
    let currentData = null;
    
    function exportReport() {
      if (!currentData) {
        alert('Geen data beschikbaar. Laad eerst data.');
        return;
      }
      
      const practice = document.getElementById('practice').value;
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      
      // Create CSV content
      let csv = 'Conversie Rapportage\n';
      csv += `Praktijk: ${practice}\n`;
      csv += `Periode: ${from} tot ${to}\n\n`;
      
      csv += 'Metric,Waarde,Percentage\n';
      csv += `Clicks,${currentData.metrics.totals.clicked},100%\n`;
      csv += `Leads,${currentData.metrics.totals.lead_submitted},${currentData.metrics.funnel.click_to_lead}%\n`;
      csv += `Afspraken,${currentData.metrics.totals.appointment_booked},${currentData.metrics.funnel.lead_to_appt}%\n`;
      csv += `Registraties,${currentData.metrics.totals.registered},${currentData.metrics.funnel.click_to_reg}%\n\n`;
      
      csv += 'Conversie Funnel\n';
      csv += `Click naar Lead,${currentData.metrics.funnel.click_to_lead}%\n`;
      csv += `Lead naar Afspraak,${currentData.metrics.funnel.lead_to_appt}%\n`;
      csv += `Afspraak naar Registratie,${currentData.metrics.funnel.appt_to_reg}%\n`;
      csv += `Totaal Click naar Registratie,${currentData.metrics.funnel.click_to_reg}%\n\n`;
      
      csv += 'Dagelijkse Data\n';
      csv += 'Datum,Clicks,Leads,Afspraken,Registraties\n';
      
      const days = {};
      currentData.series.rows.forEach(r => {
        if (!days[r.day]) days[r.day] = { clicked: 0, lead_submitted: 0, appointment_booked: 0, registered: 0 };
        days[r.day][r.event_type] = r.count;
      });
      
      Object.keys(days).sort().forEach(day => {
        csv += `${day},${days[day].clicked},${days[day].lead_submitted},${days[day].appointment_booked},${days[day].registered}\n`;
      });
      
      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `rapportage-${practice}-${from}-${to}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Don't auto-load - wait for user to enter data and click button
    // window.addEventListener('load', loadDashboard);
  </script>
</body>
</html>