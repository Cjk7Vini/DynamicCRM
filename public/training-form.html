<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teststraat Resultaten</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 { color: #667eea; margin-bottom: 10px; font-size: 28px; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
        .required { color: #e74c3c; }
        input[type="date"], input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-box {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 13px;
            color: #555;
        }
        .success-message, .error-message {
            display: none;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        .success-message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error-message { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        hr { margin: 25px 0; border: none; border-top: 2px solid #f0f0f0; }
        .test-categories { margin-bottom: 25px; }
        .category-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
        }
        .test-card {
            background: #f8f9ff;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
        }
        .test-card:hover {
            border-color: #667eea;
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .test-card.completed {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        .test-card.completed .test-duration { color: rgba(255, 255, 255, 0.8); }
        .test-card.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        .test-card.active .test-duration { color: rgba(255, 255, 255, 0.8); }
        .checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 18px;
        }
        .test-name { font-weight: 600; font-size: 14px; margin-bottom: 5px; }
        .test-duration { font-size: 11px; color: #666; }
        .result-section {
            display: none;
            animation: fadeIn 0.3s ease;
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .result-section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .input-with-unit { display: flex; gap: 10px; align-items: center; }
        .input-with-unit input { flex: 1; }
        .input-with-unit .unit-label {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover:not(:disabled) { box-shadow: 0 10px 25px rgba(107, 114, 128, 0.3); }
        .meetmoment-select {
            background: #fff9e6;
            border: 2px solid #ffd700;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .meetmoment-select label { color: #d4a017; }
        .test-summary {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-summary h3 {
            color: #065f46;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .test-summary-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .test-summary-item strong { color: #667eea; }
        @media (max-width: 600px) {
            .container { padding: 25px; }
            .form-row { grid-template-columns: 1fr; }
            .test-grid { grid-template-columns: 1fr; }
            h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèãÔ∏è Fit & Leefstijl Teststraat</h1>
        <p class="subtitle">40+ doelgroep - Multi-test invoer</p>

        <div class="success-message" id="successMessage">‚úì Alle tests succesvol opgeslagen!</div>
        <div class="error-message" id="errorMessage">‚ùå Er ging iets mis bij het opslaan</div>

        <div class="info-box">‚ö° Klik op een test hieronder om te beginnen. Na opslaan kun je de volgende test invullen.</div>

        <form id="trainingForm">
            <input type="hidden" id="testDate" name="testDate">
            <input type="hidden" id="testTime" name="testTime">

            <div class="form-group">
                <label for="patientName">Naam Pati√´nt <span class="required">*</span></label>
                <input type="text" id="patientName" name="patientName" placeholder="Voor- en achternaam" required autofocus>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="birthDate">Geboortedatum <span class="required">*</span></label>
                    <input type="date" id="birthDate" name="birthDate" required>
                </div>
                <div class="form-group">
                    <label for="gender">Geslacht <span class="required">*</span></label>
                    <select id="gender" name="gender" required>
                        <option value="">-- Selecteer --</option>
                        <option value="M">Man</option>
                        <option value="V">Vrouw</option>
                        <option value="X">Anders/Onbekend</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="practiceSection">
                <label for="practiceDisplay">Praktijk <span class="required">*</span></label>
                <input type="text" id="practiceDisplay" readonly style="background: #f3f4f6; cursor: not-allowed; font-weight: 600; color: #667eea;">
                <input type="hidden" id="practiceCode" name="practiceCode" required>
                <small style="color: #10b981; font-size: 12px; margin-top: 4px; display: block;" id="practiceHint">‚úì Praktijk automatisch herkend</small>
            </div>

            <div class="meetmoment-select">
                <label for="measurementPhase">Meetmoment <span class="required">*</span></label>
                <select id="measurementPhase" name="measurementPhase" required>
                    <option value="">-- Selecteer meetmoment --</option>
                    <option value="week0">Week 0 - Nulmeting</option>
                    <option value="week6">Week 6 - Voortgang</option>
                    <option value="week12">Week 12 - Evaluatie</option>
                </select>
            </div>

            <hr>

            <div class="test-categories">
                <div class="category-title">1Ô∏è‚É£ Lichaamssamenstelling</div>
                <div class="test-grid">
                    <div class="test-card" data-test="bia">
                        <div class="test-name">BIA</div>
                        <div class="test-duration">Complete body analyse ‚Ä¢ 3 min</div>
                    </div>
                </div>

                <div class="category-title">2Ô∏è‚É£ Spierkracht</div>
                <div class="test-grid">
                    <div class="test-card" data-test="handgrip">
                        <div class="test-name">Handknijpkracht</div>
                        <div class="test-duration">Algemene kracht ‚Ä¢ 2 min</div>
                    </div>
                    <div class="test-card" data-test="chair_stand">
                        <div class="test-name">30-sec Chair Stand</div>
                        <div class="test-duration">Beenspierkracht ‚Ä¢ 2 min</div>
                    </div>
                    <div class="test-card" data-test="arm_curl">
                        <div class="test-name">Arm Curl</div>
                        <div class="test-duration">Armkracht ‚Ä¢ 2 min</div>
                    </div>
                </div>

                <div class="category-title">3Ô∏è‚É£ Balans & Flexibiliteit</div>
                <div class="test-grid">
                    <div class="test-card" data-test="one_leg_stand">
                        <div class="test-name">E√©n-been-stand</div>
                        <div class="test-duration">Evenwicht ‚Ä¢ 1 min</div>
                    </div>
                    <div class="test-card" data-test="sit_reach">
                        <div class="test-name">Sit & Reach</div>
                        <div class="test-duration">Lenigheid ‚Ä¢ 2 min</div>
                    </div>
                    <div class="test-card" data-test="shoulder_mobility">
                        <div class="test-name">Schoudermobiliteit</div>
                        <div class="test-duration">ROM bovenlichaam ‚Ä¢ 2 min</div>
                    </div>
                </div>

                <div class="category-title">4Ô∏è‚É£ Uithoudingsvermogen</div>
                <div class="test-grid">
                    <div class="test-card" data-test="walk_6min">
                        <div class="test-name">6-Min Wandeltest</div>
                        <div class="test-duration">Aerobe capaciteit ‚Ä¢ 8 min</div>
                    </div>
                    <div class="test-card" data-test="step_2min">
                        <div class="test-name">2-Min Step-test</div>
                        <div class="test-duration">Alternatief 6MWT ‚Ä¢ 3 min</div>

    function getPracticeCodeFromURL() {
        var urlParams = new URLSearchParams(window.location.search);
        // ‚úÖ FIX: Check voor 'practice', 'p', of 's'
        return urlParams.get('practice') || urlParams.get('p') || urlParams.get('s') || null;
    }

    function loadPractices() {
        var urlPracticeCode = getPracticeCodeFromURL();
        
        if (!urlPracticeCode) {
            var errorHtml = '<div style="background:#fee2e2;border:2px solid #ef4444;border-radius:12px;padding:20px;text-align:center">' +
                '<div style="font-size:48px;margin-bottom:16px">üö´</div>' +
                '<h3 style="color:#991b1b;margin-bottom:12px">Geen toegang</h3>' +
                '<p style="color:#7f1d1d">Deze pagina is alleen toegankelijk via een unieke praktijklink.</p></div>';
            document.getElementById('practiceSection').innerHTML = errorHtml;
            document.getElementById('trainingForm').style.pointerEvents = 'none';
            document.getElementById('trainingForm').style.opacity = '0.5';
            return;
        }
        
        // ‚úÖ FIX: Gebruik /api/validate-practice in plaats van /api/practices
        fetch('/api/validate-practice?code=' + encodeURIComponent(urlPracticeCode))
            .then(function(r) { return r.json(); })
            .then(function(response) {
                if (response.valid && response.practice) {
                    // Praktijk bestaat en is actief
                    document.getElementById('practiceDisplay').value = response.practice.naam + ' (' + response.practice.code + ')';
                    document.getElementById('practiceCode').value = response.practice.code;
                } else {
                    // Praktijk bestaat niet of is niet actief
                    var errorHtml = '<div style="background:#fee2e2;border:2px solid #ef4444;border-radius:12px;padding:20px;text-align:center">' +
                        '<div style="font-size:48px;margin-bottom:16px">üö´</div>' +
                        '<h3 style="color:#991b1b;margin-bottom:12px">Geen toegang</h3>' +
                        '<p style="color:#7f1d1d">Deze pagina is alleen toegankelijk via een unieke praktijklink.</p></div>';
                    document.getElementById('practiceSection').innerHTML = errorHtml;
                    document.getElementById('trainingForm').style.pointerEvents = 'none';
                    document.getElementById('trainingForm').style.opacity = '0.5';
                }
            })
            .catch(function(error) {
                console.error('Practice validation error:', error);
                var errorHtml = '<div style="background:#fee2e2;border:2px solid #ef4444;border-radius:12px;padding:20px;text-align:center">' +
                    '<div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>' +
                    '<h3 style="color:#991b1b;margin-bottom:12px">Fout bij laden</h3>' +
                    '<p style="color:#7f1d1d">Kon praktijk niet valideren. Probeer het later opnieuw.</p></div>';
                document.getElementById('practiceSection').innerHTML = errorHtml;
                document.getElementById('trainingForm').style.pointerEvents = 'none';
                document.getElementById('trainingForm').style.opacity = '0.5';
            });
    }

    loadPractices();
        fetch('/api/practices')
            .then(function(response) { return response.json(); })
            .then(function(practices) {
                var practice = practices.find(function(p) { return p.code === urlPracticeCode; });
                if (practice) {
                    document.getElementById('practiceDisplay').value = practice.naam + ' (' + practice.code + ')';
                    document.getElementById('practiceCode').value = practice.code;
                    document.getElementById('practiceHint').innerHTML = '‚úì Praktijk automatisch herkend';
                } else {
                    document.getElementById('practiceDisplay').value = 'Onbekende praktijkcode: ' + urlPracticeCode;
                    document.getElementById('practiceCode').value = urlPracticeCode;
                }
            })
            .catch(function(error) {
                document.getElementById('practiceDisplay').value = 'Praktijk ' + urlPracticeCode;
                document.getElementById('practiceCode').value = urlPracticeCode;
            });
    }

    loadPractices();

    var testConfigs = {
        bia: { fields: [
            { name: 'gewicht', label: 'Gewicht', unit: 'kg' },
            { name: 'lengte', label: 'Lengte', unit: 'cm' },
            { name: 'vetpercentage', label: 'Vetpercentage', unit: '%' },
            { name: 'spiermassa', label: 'Spiermassa', unit: 'kg' },
            { name: 'basale_stofwisseling', label: 'Basale Stofwisseling', unit: 'kcal' }
        ]},
        handgrip: { fields: [
            { name: 'links', label: 'Links', unit: 'kg' },
            { name: 'rechts', label: 'Rechts', unit: 'kg' }
        ]},
        chair_stand: { fields: [{ name: 'herhalingen', label: 'Aantal herhalingen', unit: 'x' }]},
        arm_curl: { fields: [{ name: 'herhalingen', label: 'Aantal herhalingen', unit: 'x' }]},
        one_leg_stand: { fields: [{ name: 'tijd', label: 'Tijd volgehouden', unit: 'sec' }]},
        sit_reach: { fields: [{ name: 'afstand', label: 'Afstand', unit: 'cm' }]},
        shoulder_mobility: { fields: [{ name: 'afstand', label: 'Afstand', unit: 'cm' }]},
        walk_6min: { fields: [{ name: 'afstand', label: 'Afstand', unit: 'm' }]},
        step_2min: { fields: [{ name: 'herhalingen', label: 'Aantal herhalingen', unit: 'x' }]}
    };

    var savedTests = {};
    var allTests = ['bia','handgrip','chair_stand','arm_curl','one_leg_stand','sit_reach','shoulder_mobility','walk_6min','step_2min'];
    var currentTestIndex = -1;

    var testCards = document.querySelectorAll('.test-card');
    var resultSectionsContainer = document.getElementById('resultSections');
    var submitBtn = document.getElementById('submitBtn');
    var testSummary = document.getElementById('testSummary');
    var summaryContent = document.getElementById('summaryContent');

    testCards.forEach(function(card) {
        card.addEventListener('click', function() {
            var testType = this.getAttribute('data-test');
            currentTestIndex = allTests.indexOf(testType);
            testCards.forEach(function(c) { c.classList.remove('active'); });
            card.classList.add('active');
            generateResultFields(testType);
            setTimeout(function() {
                resultSectionsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        });
    });

    function getTestName(testType) {
        var names = {
            bia: 'BIA', handgrip: 'Handknijpkracht', chair_stand: '30-sec Chair Stand',
            arm_curl: 'Arm Curl', one_leg_stand: 'E√©n-been-stand', sit_reach: 'Sit & Reach',
            shoulder_mobility: 'Schoudermobiliteit', walk_6min: '6-Min Wandeltest', step_2min: '2-Min Step-test'
        };
        return names[testType] || testType;
    }

    function generateResultFields(testType) {
        var config = testConfigs[testType];
        var html = '<div class="result-section active" data-test="' + testType + '">';
        html += '<h3 style="color:#667eea;margin-bottom:15px">üìù ' + getTestName(testType) + '</h3>';
        
        config.fields.forEach(function(field) {
            var savedValue = (savedTests[testType] && savedTests[testType][field.name]) || '';
            html += '<div class="form-group">';
            html += '<label for="' + testType + '_' + field.name + '">' + field.label + ' <span class="required">*</span></label>';
            html += '<div class="input-with-unit">';
            html += '<input type="number" id="' + testType + '_' + field.name + '" step="0.1" placeholder="Voer waarde in" value="' + savedValue + '" required>';
            html += '<span class="unit-label">' + field.unit + '</span>';
            html += '</div></div>';
        });
        
        html += '<button type="button" class="btn-secondary" onclick="saveCurrentTest(\'' + testType + '\')">‚úì ' + getTestName(testType) + ' Opslaan</button>';
        html += '</div>';
        
        resultSectionsContainer.innerHTML = html;
        var firstInput = resultSectionsContainer.querySelector('input');
        if (firstInput) firstInput.focus();
    }

    window.saveCurrentTest = function(testType) {
        var config = testConfigs[testType];
        var testData = {};
        var allFilled = true;
        
        config.fields.forEach(function(field) {
            var input = document.getElementById(testType + '_' + field.name);
            if (input && input.value) {
                testData[field.name] = input.value;
            } else {
                allFilled = false;
            }
        });
        
        if (!allFilled) {
            alert('Vul alle velden in voordat je opslaat');
            return;
        }
        
        savedTests[testType] = testData;
        
        var card = document.querySelector('[data-test="' + testType + '"]');
        if (card) {
            card.classList.remove('active');
            card.classList.add('completed');
            if (!card.querySelector('.checkmark')) {
                var checkmark = document.createElement('span');
                checkmark.className = 'checkmark';
                checkmark.textContent = '‚úì';
                card.insertBefore(checkmark, card.firstChild);
            }
        }
        
        updateSummary();
        
        currentTestIndex++;
        
        if (currentTestIndex < allTests.length) {
            var nextTestType = allTests[currentTestIndex];
            var nextCard = document.querySelector('[data-test="' + nextTestType + '"]');
            testCards.forEach(function(c) { c.classList.remove('active'); });
            if (nextCard) nextCard.classList.add('active');
            generateResultFields(nextTestType);
            setTimeout(function() {
                var firstInput = resultSectionsContainer.querySelector('input[type="number"]');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        } else {
            showCompletionScreen();
        }
    };

    function showCompletionScreen() {
        var html = '<div style="background:#f0fdf4;border:2px solid #10b981;border-radius:16px;padding:30px;text-align:center">';
        html += '<div style="font-size:64px;margin-bottom:16px">üéâ</div>';
        html += '<h2 style="color:#065f46;margin-bottom:16px">Alle tests voltooid!</h2>';
        html += '<p style="color:#047857;margin-bottom:24px">Je hebt ' + Object.keys(savedTests).length + ' tests ingevuld. Klik hieronder om alles op te slaan.</p>';
        html += '</div>';
        resultSectionsContainer.innerHTML = html;
        testCards.forEach(function(c) { c.classList.remove('active'); });
        submitBtn.style.display = 'block';
        submitBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function updateSummary() {
        if (Object.keys(savedTests).length === 0) {
            testSummary.style.display = 'none';
            return;
        }
        testSummary.style.display = 'block';
        var html = '';
        for (var testType in savedTests) {
            html += '<div class="test-summary-item"><strong>' + getTestName(testType) + ':</strong> ' + Object.keys(savedTests[testType]).length + ' metingen</div>';
        }
        summaryContent.innerHTML = html;
    }

    document.getElementById('trainingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (Object.keys(savedTests).length === 0) {
            alert('Vul minimaal √©√©n test in voordat je opslaat');
            return;
        }
        
        var submitBtn = document.getElementById('submitBtn');
        var successMsg = document.getElementById('successMessage');
        var errorMsg = document.getElementById('errorMessage');
        
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Bezig met opslaan...';
        
        var baseData = {
            date: document.getElementById('testDate').value,
            time: document.getElementById('testTime').value,
            patientName: document.getElementById('patientName').value,
            birthDate: document.getElementById('birthDate').value,
            gender: document.getElementById('gender').value,
            practiceCode: document.getElementById('practiceCode').value,
            measurementPhase: document.getElementById('measurementPhase').value,
            notes: document.getElementById('notes').value
        };

        var promises = [];
        for (var testType in savedTests) {
            var formData = Object.assign({}, baseData, { testType: testType, results: {} });
            var config = testConfigs[testType];
            config.fields.forEach(function(field) {
                if (savedTests[testType][field.name]) {
                    formData.results[field.name] = {
                        value: savedTests[testType][field.name],
                        unit: field.unit
                    };
                }
            });
            promises.push(fetch('/api/training-results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            }));
        }

        Promise.all(promises).then(function() {
            successMsg.style.display = 'block';
            errorMsg.style.display = 'none';
            document.getElementById('trainingForm').reset();
            savedTests = {};
            testCards.forEach(function(c) {
                c.classList.remove('active', 'completed');
                var checkmark = c.querySelector('.checkmark');
                if (checkmark) checkmark.remove();
            });
            resultSectionsContainer.innerHTML = '';
            testSummary.style.display = 'none';
            submitBtn.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ Alle Tests Opslaan';
            document.getElementById('patientName').focus();
            setTimeout(function() { successMsg.style.display = 'none'; }, 5000);
        }).catch(function(error) {
            errorMsg.textContent = '‚ùå ' + error.message;
            errorMsg.style.display = 'block';
            successMsg.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.textContent = 'üíæ Alle Tests Opslaan';
            setTimeout(function() { errorMsg.style.display = 'none'; }, 5000);
        });
    });
})();
    </script>
</body>
</html>