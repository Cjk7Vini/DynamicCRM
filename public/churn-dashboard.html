<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Health Analytics - Churn & Conversie Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.5;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #d2d2d7;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }
        
        .logo { 
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px; 
            font-weight: 700; 
            color: #06c; 
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
        }
        
        .header-title { 
            font-size: 16px; 
            font-weight: 400;
            color: #86868b;
        }
        
        .header-right { 
            display: flex; 
            gap: 16px; 
            align-items: center; 
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: #f5f5f7;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .user-icon {
            width: 32px;
            height: 32px;
            background: #06c;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-email {
            color: #1d1d1f;
            font-weight: 500;
        }
        
        .user-role {
            color: #86868b;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .btn-logout {
            padding: 8px 16px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-logout:hover {
            background: #ff453a;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary { 
            background: #06c; 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: #0077ed; 
        }
        
        .btn-secondary { 
            background: white; 
            color: #1d1d1f; 
            border: 1px solid #d2d2d7; 
        }
        
        .btn-secondary:hover { 
            background: #f5f5f7; 
        }

        /* Power BI Style Sidebar */
        .dashboard-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 220px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 0 20px;
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #86868b;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
            display: block;
        }

        select, input[type="date"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: #06c;
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #f5f5f7;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }

        .kpi-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #86868b;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #1d1d1f;
            line-height: 1;
        }

        .kpi-subtitle {
            font-size: 13px;
            color: #86868b;
            margin-top: 4px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 16px;
        }

        .chart-subtitle {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 16px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Error & Loading States */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            border-left: 4px solid #c62828;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .dashboard-container {
                flex-direction: column;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Pipeline Funnel Styles */
        .funnel-stage {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 12px;
        }

        .funnel-bar {
            flex: 1;
            height: 50px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            color: white;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 14px;
        }

        .funnel-bar:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .funnel-bar.awareness { background: #3b82f6; }
        .funnel-bar.interest { background: #06b6d4; }
        .funnel-bar.intent { background: #10b981; }
        .funnel-bar.consideration { background: #f59e0b; }
        .funnel-bar.decision { background: #ef4444; }
        .funnel-bar.won { background: #22c55e; }

        .funnel-count {
            margin-left: auto;
            font-size: 18px;
            font-weight: 700;
        }

        .funnel-stats {
            min-width: 120px;
            text-align: right;
            font-size: 12px;
            color: #64748b;
        }

        .conversion-rate {
            display: block;
            font-weight: 600;
            color: #10b981;
            margin-top: 4px;
        }

        /* Hot Leads List */
        .hot-lead-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #ef4444;
        }

        .hot-lead-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .hot-lead-meta {
            font-size: 12px;
            color: #64748b;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .hot-lead-likelihood {
            color: #ef4444;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#06c"/>
                    <path d="M16 8L24 16L16 24L8 16L16 8Z" fill="white"/>
                </svg>
                Dynamic Health
            </div>
            <div class="header-title">Churn & Conversie Analytics</div>
        </div>
        <div class="header-right">
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-icon" id="userIcon">A</div>
                <div>
                    <div class="user-email" id="userEmail">Loading...</div>
                    <div class="user-role" id="userRole">...</div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="exportToExcel()" style="margin-right: 12px;">üìä Export Rapportage</button>
            <button class="btn btn-primary" onclick="refreshData()">‚Üª Vernieuwen</button>
            <button class="btn-logout" onclick="logout()">Uitloggen</button>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Sidebar Filters -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Filters</div>
                
                <div class="filter-group">
                    <label class="filter-label" for="practiceFilter">Praktijk</label>
                    <select id="practiceFilter" onchange="applyFilters()">
                        <option value="">Alle praktijken</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="dateFrom">Van datum</label>
                    <input type="date" id="dateFrom" onchange="applyFilters()">
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="dateTo">Tot datum</label>
                    <input type="date" id="dateTo" onchange="applyFilters()">
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="sourceFilter">Bron</label>
                    <select id="sourceFilter" onchange="applyFilters()">
                        <option value="">Alle bronnen</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Google">Google</option>
                        <option value="Vrienden/Familie">Vrienden/Familie</option>
                        <option value="Voucher">Voucher</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="statusFilter">Status</label>
                    <select id="statusFilter" onchange="applyFilters()">
                        <option value="">Alle statussen</option>
                        <option value="Nieuw">Nieuw</option>
                        <option value="Gebeld">Gebeld</option>
                        <option value="Afspraak Gepland">Afspraak Gepland</option>
                        <option value="Geweest">Geweest</option>
                        <option value="Lid Geworden">Lid Geworden</option>
                        <option value="Niet Ge√Ønteresseerd">Niet Ge√Ønteresseerd</option>
                    </select>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Totaal Leads</div>
                    <div class="kpi-value" id="totalLeads">-</div>
                    <div class="kpi-subtitle">Alle leads in database</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Conversie Ratio</div>
                    <div class="kpi-value" id="conversionRate">-</div>
                    <div class="kpi-subtitle">Lead ‚Üí Lid Geworden</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Actieve Praktijken</div>
                    <div class="kpi-value" id="activePractices">-</div>
                    <div class="kpi-subtitle">Praktijken met leads</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Gemiddelde Tijd</div>
                    <div class="kpi-value" id="avgTime">-</div>
                    <div class="kpi-subtitle">Lead ‚Üí Lid Geworden</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-label">Top Bron</div>
                    <div class="kpi-value" id="topSource">-</div>
                    <div class="kpi-subtitle">Meeste leads</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Churn Forecast -->
                <div class="chart-container">
                    <div class="chart-title">Churn Forecast</div>
                    <div class="chart-subtitle">Voorspelling ledenaantal & uitval</div>
                    <div class="chart-wrapper">
                        <canvas id="churnForecastChart"></canvas>
                    </div>
                </div>

                <!-- Conversion Funnel -->
                <div class="chart-container">
                    <div class="chart-title">Conversie Funnel</div>
                    <div class="chart-subtitle">Lead journey van klik tot lid</div>
                    <div class="chart-wrapper">
                        <canvas id="conversionFunnelChart"></canvas>
                    </div>
                </div>

                <!-- Practice Performance -->
                <div class="chart-container">
                    <div class="chart-title">Praktijk Performance</div>
                    <div class="chart-subtitle">Top 10 praktijken naar totale leads</div>
                    <div class="chart-wrapper">
                        <canvas id="practiceChart"></canvas>
                    </div>
                </div>

                <!-- Source Distribution -->
                <div class="chart-container">
                    <div class="chart-title">Lead Bronnen</div>
                    <div class="chart-subtitle">Distributie per marketing kanaal</div>
                    <div class="chart-wrapper">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ENHANCED: Pipeline Funnel Section -->
            <div class="chart-container" style="grid-column: 1 / -1; margin-top: 20px;">
                <div class="chart-title">Sales Pipeline - Lead Lifecycle</div>
                <div class="chart-subtitle">Van awareness tot conversie - zie waar leads uitvallen</div>
                
                <div id="pipelineFunnelContainer" style="padding: 20px 0;">
                    <div class="loading">Data laden...</div>
                </div>
            </div>

            <!-- ENHANCED: Forecast vs Actual -->
            <div class="charts-grid" style="margin-top: 20px;">
                <div class="chart-container">
                    <div class="chart-title">Forecast vs Actueel</div>
                    <div class="chart-subtitle">Verwachte vs werkelijke conversies</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                        <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border: 2px solid #93c5fd;">
                            <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px;">VERWACHT</div>
                            <div id="forecastExpected" style="font-size: 32px; font-weight: 700; color: #2563eb;">-</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Op basis van likelihood</div>
                        </div>
                        
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border: 2px solid #86efac;">
                            <div style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px;">ACTUEEL</div>
                            <div id="forecastActual" style="font-size: 32px; font-weight: 700; color: #10b981;">-</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Daadwerkelijk gewonnen</div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 16px; border-radius: 8px; text-align: center; margin-top: 16px;">
                        <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 4px;">GAP ANALYSE</div>
                        <div id="gapValue" style="font-size: 24px; font-weight: 700; color: #92400e;">-</div>
                        <div id="gapDescription" style="font-size: 12px; color: #78350f; margin-top: 4px;">-</div>
                    </div>
                </div>

                <!-- Hot Leads -->
                <div class="chart-container">
                    <div class="chart-title">Hot Leads</div>
                    <div class="chart-subtitle">Hoge conversiekans (70%+)</div>
                    
                    <div id="hotLeadsList" style="margin-top: 16px;">
                        <div class="loading">Data laden...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // User session state
        let currentUser = null;
        
        // Chart instances
        let churnForecastChart, conversionFunnelChart, practiceChart, sourceChart;

        // Check authentication on page load
        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'include' });
                if (!res.ok) {
                    window.location.href = '/login.html';
                    return false;
                }
                const data = await res.json();
                currentUser = data.user;
                updateUserUI();
                return true;
            } catch (err) {
                console.error('Auth check failed:', err);
                window.location.href = '/login.html';
                return false;
            }
        }

        // Update user info in header
        function updateUserUI() {
            if (!currentUser) return;
            
            const userInfo = document.getElementById('userInfo');
            const userIcon = document.getElementById('userIcon');
            const userEmail = document.getElementById('userEmail');
            const userRole = document.getElementById('userRole');
            
            // Show user info
            userInfo.style.display = 'flex';
            
            // Set user icon (first letter of email)
            userIcon.textContent = currentUser.email.charAt(0).toUpperCase();
            
            // Set email and role
            userEmail.textContent = currentUser.email;
            userRole.textContent = currentUser.role === 'admin' ? 'Administrator' : 'Praktijk';
            
            // If practice user, hide admin-only features
            if (currentUser.role === 'practice') {
                hideAdminFeatures();
            }
        }

        // Hide admin-only features for practice users
        function hideAdminFeatures() {
            // Hide practice filter (can only see own data)
            const practiceFilter = document.getElementById('practiceFilter');
            if (practiceFilter && practiceFilter.parentElement) {
                practiceFilter.parentElement.parentElement.style.display = 'none';
            }
            
            // Hide export button (optional - remove if practices should export too)
            // document.querySelector('[onclick="exportToExcel()"]').style.display = 'none';
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', { 
                    method: 'POST',
                    credentials: 'include' 
                });
            } catch (err) {
                console.error('Logout failed:', err);
            }
            window.location.href = '/login.html';
        }

        // Initialize dashboard
        async function init() {
            // Check auth first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
            
            await loadPractices();
            await loadKPIs();
            await loadChurnForecast();
            await loadConversionFunnel();
            await loadPracticePerformance();
            await loadSourcePerformance();
            
            // NEW: Enhanced dashboard features
            await loadPipelineFunnel();
            await loadForecastComparison();
            await loadHotLeads();
        }

        // Load practices for dropdown
        async function loadPractices() {
            try {
                const res = await fetch('/api/churn/practices');
                const data = await res.json();
                
                if (data.success && data.practices) {
                    const select = document.getElementById('practiceFilter');
                    select.innerHTML = '<option value="">Alle praktijken</option>';
                    
                    data.practices.forEach(practice => {
                        const option = document.createElement('option');
                        option.value = practice.code;
                        option.textContent = practice.naam;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading practices:', error);
            }
        }

        // Load KPIs
        async function loadKPIs() {
            try {
                const res = await fetch('/api/practice-performance' + buildQueryString());
                const data = await res.json();
                
                if (data.success && data.data) {
                    // Calculate totals
                    const totalLeads = data.data.reduce((sum, p) => sum + parseInt(p.total_leads || 0), 0);
                    const totalConverted = data.data.reduce((sum, p) => sum + parseInt(p.lid_geworden || 0), 0);
                    const conversionRate = totalLeads > 0 ? ((totalConverted / totalLeads) * 100).toFixed(1) : 0;
                    const activePractices = data.data.filter(p => p.total_leads > 0).length;
                    
                    // Update KPI cards
                    document.getElementById('totalLeads').textContent = totalLeads.toLocaleString();
                    document.getElementById('conversionRate').textContent = conversionRate + '%';
                    document.getElementById('activePractices').textContent = activePractices;
                    
                    // Get top source
                    const sourcesRes = await fetch('/api/sources' + buildQueryString());
                    const sourcesData = await sourcesRes.json();
                    if (sourcesData.success && sourcesData.sources.length > 0) {
                        document.getElementById('topSource').textContent = sourcesData.sources[0].source || 'Onbekend';
                    }
                    
                    // Calculate average time (mock for now)
                    document.getElementById('avgTime').textContent = '12d';
                }
            } catch (error) {
                console.error('Error loading KPIs:', error);
            }
        }

        // Load Churn Forecast Chart
        async function loadChurnForecast() {
            try {
                const res = await fetch('/api/churn-forecast');
                const data = await res.json();
                
                if (data.success) {
                    const allData = [...(data.historical || []), ...(data.forecast || [])];
                    
                    const ctx = document.getElementById('churnForecastChart');
                    if (churnForecastChart) churnForecastChart.destroy();
                    
                    churnForecastChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: allData.map(d => d.month),
                            datasets: [
                                {
                                    label: 'Total Members',
                                    data: allData.map(d => d.total_members),
                                    borderColor: '#06c',
                                    backgroundColor: 'rgba(0,102,204,0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    borderDash: allData.map((d, i) => d.is_forecast ? [5, 5] : [])
                                },
                                {
                                    label: 'Churned Members',
                                    data: allData.map(d => d.churned_members),
                                    borderColor: '#ff3b30',
                                    backgroundColor: 'rgba(255,59,48,0.1)',
                                    borderWidth: 2,
                                    tension: 0.4,
                                    borderDash: allData.map((d, i) => d.is_forecast ? [5, 5] : [])
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading churn forecast:', error);
                showError('churnForecastChart', error.message);
            }
        }

        // Load Conversion Funnel
        async function loadConversionFunnel() {
            try {
                const res = await fetch('/api/conversion-funnel' + buildQueryString());
                const data = await res.json();
                
                if (data.success && data.data) {
                    const ctx = document.getElementById('conversionFunnelChart');
                    if (conversionFunnelChart) conversionFunnelChart.destroy();
                    
                    conversionFunnelChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.data.map(d => d.stage),
                            datasets: [{
                                label: 'Count',
                                data: data.data.map(d => d.count),
                                backgroundColor: [
                                    '#06c',
                                    '#34c759',
                                    '#ff9500',
                                    '#ff3b30'
                                ]
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading funnel:', error);
                showError('conversionFunnelChart', error.message);
            }
        }

        // Load Practice Performance
        async function loadPracticePerformance() {
            try {
                const res = await fetch('/api/practice-performance');
                const data = await res.json();
                
                if (data.success && data.data) {
                    const topPractices = data.data.slice(0, 10);
                    
                    const ctx = document.getElementById('practiceChart');
                    if (practiceChart) practiceChart.destroy();
                    
                    practiceChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: topPractices.map(d => d.praktijk_naam || d.praktijk_code),
                            datasets: [{
                                label: 'Total Leads',
                                data: topPractices.map(d => d.total_leads),
                                backgroundColor: '#06c'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading practice performance:', error);
            }
        }

        // Load Source Performance
        async function loadSourcePerformance() {
            try {
                const res = await fetch('/api/sources');
                const data = await res.json();
                
                if (data.success && data.sources) {
                    const ctx = document.getElementById('sourceChart');
                    if (sourceChart) sourceChart.destroy();
                    
                    sourceChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.sources.map(d => d.source || 'Onbekend'),
                            datasets: [{
                                data: data.sources.map(d => d.count),
                                backgroundColor: [
                                    '#2563eb', // Blue
                                    '#10b981', // Green
                                    '#f59e0b', // Orange
                                    '#8b5cf6', // Purple
                                    '#ef4444', // Red
                                    '#06b6d4', // Cyan
                                    '#ec4899', // Pink
                                    '#14b8a6', // Teal
                                    '#f97316', // Deep Orange
                                    '#6366f1', // Indigo
                                    '#84cc16', // Lime
                                    '#a855f7'  // Violet
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading sources:', error);
            }
        }

        // Build query string from filters
        function buildQueryString() {
            const params = new URLSearchParams();
            
            // If practice user, force their practice code
            if (currentUser && currentUser.role === 'practice' && currentUser.practice_code) {
                params.append('practice', currentUser.practice_code);
            } else if (currentUser && currentUser.role === 'admin') {
                // Admin can filter by practice - only if explicitly selected
                const practiceFilter = document.getElementById('practiceFilter');
                if (practiceFilter && practiceFilter.value) {
                    params.append('practice', practiceFilter.value);
                }
                // If no filter selected, show ALL (don't add practice param)
            }
            
            const source = document.getElementById('sourceFilter').value;
            if (source) params.append('source', source);
            
            const dateFrom = document.getElementById('dateFrom').value;
            if (dateFrom) params.append('dateFrom', dateFrom);
            
            const dateTo = document.getElementById('dateTo').value;
            if (dateTo) params.append('dateTo', dateTo);
            
            const status = document.getElementById('statusFilter').value;
            if (status) params.append('status', status);
            
            const queryString = params.toString();
            return queryString ? '?' + queryString : '';
        }

        // Apply filters
        function applyFilters() {
            loadKPIs();
            loadConversionFunnel();
            loadPracticePerformance();
            loadSourcePerformance();
            
            // NEW: Also reload enhanced sections
            loadPipelineFunnel();
            loadForecastComparison();
            loadHotLeads();
        }

        // Refresh all data
        function refreshData() {
            init();
        }

        // Show error message
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                const parent = element.parentElement;
                parent.innerHTML = `<div class="error-message">Error: ${message}</div>`;
            }
        }

        // Excel Export Function
        async function exportToExcel() {
            try {
                const filters = getCurrentFilters();
                
                // Get practice name - for practice users, use their practice name
                let practiceName = 'Alle praktijken';
                if (currentUser && currentUser.role === 'practice') {
                    // For practice users, get their practice name from the dropdown or API
                    const practiceFilter = document.getElementById('practiceFilter');
                    const selectedOption = Array.from(practiceFilter.options).find(
                        opt => opt.value === currentUser.practice_code
                    );
                    practiceName = selectedOption ? selectedOption.text : currentUser.practice_code;
                } else {
                    // For admin, use selected filter
                    practiceName = document.getElementById('practiceFilter').selectedOptions[0]?.text || 'Alle praktijken';
                }
                
                const dateRange = filters.dateFrom && filters.dateTo 
                    ? `${filters.dateFrom} tot ${filters.dateTo}` 
                    : 'Alle data';

                // Fetch all data with current filters
                const [funnelRes, performanceRes, sourcesRes, forecastRes] = await Promise.all([
                    fetch('/api/funnel' + buildQueryString()),
                    fetch('/api/practice-performance' + buildQueryString()),
                    fetch('/api/sources' + buildQueryString()),
                    fetch('/api/churn-forecast' + buildQueryString())
                ]);

                const funnelData = await funnelRes.json();
                const performanceData = await performanceRes.json();
                const sourcesData = await sourcesRes.json();
                const forecastData = await forecastRes.json();

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Sheet 1: Funnel Data
                if (funnelData.success && funnelData.data) {
                    const funnelSheet = XLSX.utils.json_to_sheet(funnelData.data.map(d => ({
                        'Stage': d.stage,
                        'Aantal': d.count
                    })));
                    XLSX.utils.book_append_sheet(wb, funnelSheet, 'Conversie Funnel');
                }

                // Sheet 2: Practice Performance
                if (performanceData.success && performanceData.data) {
                    const perfSheet = XLSX.utils.json_to_sheet(performanceData.data.map(d => ({
                        'Praktijk': d.practice_name,
                        'Totaal Leads': d.total_leads,
                        'Afspraken': d.appointments,
                        'Conversies': d.conversions,
                        'Conversie %': d.conversion_rate ? `${d.conversion_rate}%` : '0%'
                    })));
                    XLSX.utils.book_append_sheet(wb, perfSheet, 'Praktijk Performance');
                }

                // Sheet 3: Source Analysis
                if (sourcesData.success && sourcesData.data) {
                    const sourcesSheet = XLSX.utils.json_to_sheet(sourcesData.data.map(d => ({
                        'Bron': d.source || 'Onbekend',
                        'Aantal Leads': d.count
                    })));
                    XLSX.utils.book_append_sheet(wb, sourcesSheet, 'Lead Bronnen');
                }

                // Sheet 4: Forecast Data
                if (forecastData.success && forecastData.forecast) {
                    const forecastSheet = XLSX.utils.json_to_sheet(forecastData.forecast.map(d => ({
                        'Maand': d.month,
                        'Voorspelde Churn': d.predicted_churn,
                        'Risico Niveau': d.risk_level
                    })));
                    XLSX.utils.book_append_sheet(wb, forecastSheet, 'Churn Forecast');
                }

                // Add metadata sheet
                const metadata = [
                    { 'Parameter': 'Export Datum', 'Waarde': new Date().toLocaleString('nl-NL') },
                    { 'Parameter': 'Praktijk Filter', 'Waarde': practiceName },
                    { 'Parameter': 'Datum Bereik', 'Waarde': dateRange },
                    { 'Parameter': 'Gegenereerd door', 'Waarde': 'Dynamic Health Analytics' }
                ];
                const metaSheet = XLSX.utils.json_to_sheet(metadata);
                XLSX.utils.book_append_sheet(wb, metaSheet, 'Export Info');

                // Generate filename
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `DHC_Analytics_${timestamp}.xlsx`;

                // Download
                XLSX.writeFile(wb, filename);

                alert('‚úÖ Rapportage succesvol ge√´xporteerd!');
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Fout bij exporteren: ' + error.message);
            }
        }

        // NEW: Load Pipeline Funnel
        async function loadPipelineFunnel() {
            try {
                const res = await fetch('/api/funnel' + buildQueryString());
                const data = await res.json();
                
                if (!data.success || !data.stages) {
                    document.getElementById('pipelineFunnelContainer').innerHTML = 
                        '<div style="text-align:center;color:#86868b;padding:20px;">Geen data beschikbaar</div>';
                    return;
                }
                
                const stages = data.stages;
                const total = stages[0]?.count || 1;
                
                let html = '';
                stages.forEach((stage, idx) => {
                    const percentage = (stage.count / total * 100).toFixed(1);
                    const convRate = idx > 0 ? stage.conversion_rate : '100.0';
                    
                    html += `
                        <div class="funnel-stage">
                            <div class="funnel-bar ${stage.stage}" style="width: ${percentage}%">
                                <span>${stage.stage_name}</span>
                                <span class="funnel-count">${stage.count}</span>
                            </div>
                            <div class="funnel-stats">
                                <div>${percentage}% of total</div>
                                ${idx > 0 ? `<span class="conversion-rate">${convRate}% conversion</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('pipelineFunnelContainer').innerHTML = html;
            } catch (error) {
                console.error('Pipeline funnel error:', error);
                document.getElementById('pipelineFunnelContainer').innerHTML = 
                    '<div style="text-align:center;color:#c62828;padding:20px;">Error loading funnel</div>';
            }
        }

        // NEW: Load Forecast Comparison
        async function loadForecastComparison() {
            try {
                const res = await fetch('/api/pipeline-metrics' + buildQueryString());
                const data = await res.json();
                
                if (!data.success) return;
                
                const expected = data.expected_conversions || 0;
                const actual = data.won_deals || 0;
                const gap = actual - expected;
                const gapPercent = expected > 0 ? ((gap / expected) * 100).toFixed(1) : 0;
                
                document.getElementById('forecastExpected').textContent = expected;
                document.getElementById('forecastActual').textContent = actual;
                document.getElementById('gapValue').textContent = 
                    `${gap >= 0 ? '+' : ''}${gap} (${gapPercent}%)`;
                
                const gapDesc = document.getElementById('gapDescription');
                if (gap >= 0) {
                    gapDesc.textContent = 'Boven forecast - excellent performance';
                    gapDesc.style.color = '#10b981';
                } else if (gap > -3) {
                    gapDesc.textContent = 'Licht onder forecast - nog bij te halen';
                    gapDesc.style.color = '#f59e0b';
                } else {
                    gapDesc.textContent = 'Onder forecast - actie vereist';
                    gapDesc.style.color = '#ef4444';
                }
            } catch (error) {
                console.error('Forecast comparison error:', error);
            }
        }

        // NEW: Load Hot Leads
        async function loadHotLeads() {
            try {
                // Use buildQueryString to apply practice isolation
                const queryString = buildQueryString();
                const url = `/api/hot-leads?limit=5${queryString ? '&' + queryString.substring(1) : ''}`;
                const res = await fetch(url);
                const data = await res.json();
                
                const container = document.getElementById('hotLeadsList');
                
                if (!data.success || !data.leads || data.leads.length === 0) {
                    container.innerHTML = '<div style="text-align:center;color:#86868b;padding:20px;font-size:12px;">Geen hot leads</div>';
                    return;
                }
                
                let html = '';
                data.leads.forEach(lead => {
                    html += `
                        <div class="hot-lead-item">
                            <div class="hot-lead-name">${lead.volledige_naam}</div>
                            <div class="hot-lead-meta">
                                <span>${lead.praktijk_naam || 'Geen praktijk'}</span>
                                <span>${lead.funnel_stage}</span>
                                <span class="hot-lead-likelihood">${lead.conversion_likelihood}% kans</span>
                                <span>‚Ç¨${parseFloat(lead.expected_value || 0).toFixed(0)}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Hot leads error:', error);
                document.getElementById('hotLeadsList').innerHTML = 
                    '<div style="text-align:center;color:#c62828;padding:20px;font-size:12px;">Error loading hot leads</div>';
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
