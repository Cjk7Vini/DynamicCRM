<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Health - Churn & Conversie Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            color: #212529;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: #2c3e50;
            padding: 20px 0;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo h2 {
            color: white;
            font-size: 20px;
            font-weight: 600;
        }
        
        .logo p {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            margin-top: 5px;
        }
        
        .nav-item {
            padding: 12px 20px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left: 3px solid #3498db;
        }
        
        .nav-icon {
            display: inline-block;
            width: 16px;
            text-align: center;
        }
        
        /* Dropdown in sidebar */
        .nav-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .nav-dropdown.open {
            max-height: 200px;
        }
        
        .nav-dropdown-item {
            padding: 10px 20px 10px 40px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .nav-dropdown-item:hover {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
        }
        
        /* Main content */
        .main-content {
            margin-left: 240px;
            min-height: 100vh;
        }
        
        /* Top bar */
        .top-bar {
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 16px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .page-title h1 {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-info:hover {
            background: #e9ecef;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-email {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .user-role {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .dropdown-arrow {
            margin-left: 8px;
            font-size: 10px;
            color: #6c757d;
        }
        
        /* User dropdown menu */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 220px;
            display: none;
            z-index: 1000;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #2c3e50;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        
        .dropdown-item.danger {
            color: #dc3545;
        }
        
        .dropdown-item.danger:hover {
            background: #fff5f5;
        }
        
        /* Content area */
        .content-area {
            padding: 30px;
        }
        
        /* Filters */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }
        
        .filters-title {
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-size: 13px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 6px;
        }
        
        .filter-input {
            padding: 10px 14px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filter-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #3498db;
        }
        
        .stat-card.green {
            border-left-color: #2ecc71;
        }
        
        .stat-card.orange {
            border-left-color: #f39c12;
        }
        
        .stat-card.red {
            border-left-color: #e74c3c;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .stat-subtitle {
            font-size: 13px;
            color: #95a5a6;
            margin-top: 4px;
        }
        
        /* Section headers */
        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .section-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .section-subtitle {
            font-size: 13px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .section-content {
            padding: 20px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f8f9fa;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        /* Chart container */
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        /* Meta Marketing specific */
        .meta-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .meta-metric-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .meta-metric-card.highlight {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .meta-metric-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .meta-metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h2>Dynamic Health</h2>
            <p>Churn & Conversie Analytics</p>
        </div>
        
        <div class="nav-item active">
            <span><span class="nav-icon">ðŸ“Š</span> Dashboard</span>
        </div>
        
        <div class="nav-item" id="marketingDropdownToggle">
            <span><span class="nav-icon">ðŸ“ˆ</span> Marketing</span>
            <span>â–¼</span>
        </div>
        <div class="nav-dropdown" id="marketingDropdown">
            <div class="nav-dropdown-item" onclick="openLeadsModal()">Leads</div>
            <div class="nav-dropdown-item" onclick="openBenaderdModal()">Benaderd</div>
        </div>
        
        <div class="nav-item">
            <span><span class="nav-icon">ðŸ”¥</span> Hot Leads</span>
        </div>
        
        <div class="nav-item">
            <span><span class="nav-icon">ðŸ“§</span> Eclub Data</span>
        </div>
        
        <div class="nav-item" id="metaMarketingNav" style="display: none;">
            <span><span class="nav-icon">ðŸ’°</span> Meta Marketing</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="page-title">
                <h1>Dashboard Overzicht</h1>
            </div>
            
            <div class="user-menu">
                <div class="user-info" id="userInfoToggle">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-email" id="userEmail">Loading...</div>
                        <div class="user-role" id="userRole">...</div>
                    </div>
                    <span class="dropdown-arrow">â–¼</span>
                </div>
                
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-item" onclick="window.location.href='/profile.html'">
                        <span>ðŸ‘¤</span> Profiel
                    </div>
                    <div class="dropdown-item" id="praktijkenMenuItem" style="display: none;" onclick="window.location.href='/praktijken.html'">
                        <span>ðŸ‘¥</span> Praktijken
                    </div>
                    <div class="dropdown-item" onclick="exportReport()">
                        <span>ðŸ“Š</span> Rapportage
                    </div>
                    <div class="dropdown-item" onclick="syncMetaData()">
                        <span>ðŸ”„</span> Sync Meta
                    </div>
                    <div class="dropdown-item" onclick="syncEclubData()">
                        <span>ðŸ”„</span> Sync Eclub
                    </div>
                    <div class="dropdown-item danger" onclick="logout()">
                        <span>ðŸšª</span> Uitloggen
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Filters -->
            <div class="filters-section" id="adminFilters" style="display: none;">
                <div class="filters-title">Filters</div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Praktijk</label>
                        <select class="filter-input" id="practiceFilter" onchange="loadAllData()">
                            <option value="">Alle praktijken</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Van datum</label>
                        <input type="date" class="filter-input" id="dateFrom" onchange="loadAllData()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tot datum</label>
                        <input type="date" class="filter-input" id="dateTo" onchange="loadAllData()">
                    </div>
                </div>
            </div>

            <!-- KPI Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Totaal Leads</div>
                    <div class="stat-value" id="totalLeads">0</div>
                    <div class="stat-subtitle">Alle leads in database</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Conversie Ratio</div>
                    <div class="stat-value" id="conversionRatio">0.0%</div>
                    <div class="stat-subtitle">Lead â†’ Lid Geworden</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">Actieve Praktijken</div>
                    <div class="stat-value" id="activePractices">0</div>
                    <div class="stat-subtitle">Praktijken met leads</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Gemiddelde Tijd</div>
                    <div class="stat-value" id="avgTime">0d</div>
                    <div class="stat-subtitle">Lead â†’ Lid Geworden</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Top Bron</div>
                    <div class="stat-value" id="topSource" style="font-size: 18px;">-</div>
                    <div class="stat-subtitle">Meeste leads</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Churn Forecast</div>
                    <div class="section-subtitle">Voorspelling ledenaantal & uitval</div>
                </div>
                <div class="section-content">
                    <div class="chart-container">
                        <canvas id="churnChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-title">Conversie Funnel</div>
                    <div class="section-subtitle">Lead journey van klik tot lid</div>
                </div>
                <div class="section-content">
                    <div class="chart-container">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <div class="section-title">Lead Bronnen</div>
                    <div class="section-subtitle">Distributie per marketing kanaal</div>
                </div>
                <div class="section-content">
                    <div class="chart-container">
                        <canvas id="sourceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Meta Marketing Section -->
            <div class="section" id="metaMarketingSection" style="display: none;">
                <div class="section-header">
                    <div class="section-title">Meta Marketing Performance</div>
                    <div class="section-subtitle">
                        <span id="metaLastSync">Laatste sync: --</span>
                        <button class="btn btn-success" onclick="syncMetaData()" style="margin-left: 16px;">Sync Nu</button>
                    </div>
                </div>
                <div class="section-content">
                    <div class="meta-metrics-grid">
                        <div class="meta-metric-card">
                            <div class="meta-metric-label">Total Ad Spend</div>
                            <div class="meta-metric-value" id="metaTotalSpend">â‚¬0.00</div>
                        </div>
                        <div class="meta-metric-card">
                            <div class="meta-metric-label">Impressions</div>
                            <div class="meta-metric-value" id="metaImpressions">0</div>
                        </div>
                        <div class="meta-metric-card">
                            <div class="meta-metric-label">Clicks</div>
                            <div class="meta-metric-value" id="metaClicks">0</div>
                        </div>
                        <div class="meta-metric-card">
                            <div class="meta-metric-label">CTR</div>
                            <div class="meta-metric-value" id="metaCTR">0.00%</div>
                        </div>
                        <div class="meta-metric-card highlight">
                            <div class="meta-metric-label">Conversions</div>
                            <div class="meta-metric-value" id="metaConversions">0</div>
                        </div>
                        <div class="meta-metric-card highlight">
                            <div class="meta-metric-label">Leads (Meta)</div>
                            <div class="meta-metric-value" id="metaVerifiedLeads">0</div>
                        </div>
                        <div class="meta-metric-card highlight">
                            <div class="meta-metric-label">Cost Per Lead</div>
                            <div class="meta-metric-value" id="metaCostPerLead">â‚¬0.00</div>
                        </div>
                        <div class="meta-metric-card">
                            <div class="meta-metric-label">ROAS</div>
                            <div class="meta-metric-value" id="metaROAS">0.0x</div>
                        </div>
                        <div class="meta-metric-card">
                            <div class="meta-metric-label">CPC</div>
                            <div class="meta-metric-value" id="metaCPC">â‚¬0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="leadsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Leads</div>
                <button class="modal-close" onclick="closeModal('leadsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <table>
                    <thead>
                        <tr>
                            <th>Naam</th>
                            <th>Email</th>
                            <th>Telefoon</th>
                            <th>Bron</th>
                            <th>Datum</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="benaderdModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Benaderd</div>
                <button class="modal-close" onclick="closeModal('benaderdModal')">&times;</button>
            </div>
            <div class="modal-body">
                <table>
                    <thead>
                        <tr>
                            <th>Naam</th>
                            <th>Email</th>
                            <th>Telefoon</th>
                            <th>Afspraak</th>
                            <th>Datum</th>
                        </tr>
                    </thead>
                    <tbody id="benaderdTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="lidModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Lid</div>
                <button class="modal-close" onclick="closeModal('lidModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Lid data komt van Eclub API (nog geen credentials)</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let churnChart = null;
        let funnelChart = null;
        let sourceChart = null;

        // Dropdown toggles
        document.getElementById('userInfoToggle').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('userDropdown').classList.toggle('show');
        });

        document.getElementById('marketingDropdownToggle').addEventListener('click', function() {
            document.getElementById('marketingDropdown').classList.toggle('open');
        });

        document.addEventListener('click', function() {
            document.getElementById('userDropdown').classList.remove('show');
        });

        // Init on page load
        async function init() {
            await checkAuth();
            await loadAllData();
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/auth/me', { credentials: 'include' });
                if (!res.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const data = await res.json();
                currentUser = data.user;
                
                // Update UI
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userRole').textContent = currentUser.role;
                document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();
                
                // Show/hide based on role
                if (currentUser.role === 'admin') {
                    document.getElementById('adminFilters').style.display = 'block';
                    document.getElementById('praktijkenMenuItem').style.display = 'flex';
                    await loadPractices();
                } else {
                    // Practice user - load only their data
                    document.getElementById('adminFilters').style.display = 'none';
                }
                
            } catch (e) {
                console.error('Auth error:', e);
                window.location.href = '/login.html';
            }
        }

        async function loadPractices() {
            try {
                const res = await fetch('/api/practices');
                const practices = await res.json();
                
                const select = document.getElementById('practiceFilter');
                select.innerHTML = '<option value="">Alle praktijken</option>';
                
                practices.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.code;
                    opt.textContent = p.naam;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Load practices error:', e);
            }
        }

        async function loadAllData() {
            await loadKPIs();
            await loadCharts();
            await loadMetaMarketing();
        }

        async function loadKPIs() {
            try {
                const practiceCode = currentUser.role === 'admin' 
                    ? document.getElementById('practiceFilter').value 
                    : currentUser.practice_code;
                
                const dateFrom = document.getElementById('dateFrom')?.value || '2025-01-01';
                const dateTo = document.getElementById('dateTo')?.value || new Date().toISOString().split('T')[0];
                
                let url = `/api/kpis?dateFrom=${dateFrom}&dateTo=${dateTo}`;
                if (practiceCode) url += `&practice=${practiceCode}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                document.getElementById('totalLeads').textContent = data.total_leads || 0;
                document.getElementById('conversionRatio').textContent = `${(data.conversion_ratio || 0).toFixed(1)}%`;
                document.getElementById('activePractices').textContent = data.active_practices || 0;
                document.getElementById('avgTime').textContent = `${data.avg_time_to_conversion || 0}d`;
                document.getElementById('topSource').textContent = data.top_source || '-';
                
            } catch (e) {
                console.error('Load KPIs error:', e);
            }
        }

        async function loadCharts() {
            // Placeholder - implement chart loading
            console.log('Charts loading...');
        }

        async function loadMetaMarketing() {
            const practiceCode = currentUser.role === 'admin' 
                ? document.getElementById('practiceFilter').value 
                : currentUser.practice_code;
            
            if (!practiceCode) {
                document.getElementById('metaMarketingSection').style.display = 'none';
                return;
            }
            
            const dateFrom = document.getElementById('dateFrom')?.value || '2025-01-01';
            const dateTo = document.getElementById('dateTo')?.value || new Date().toISOString().split('T')[0];
            
            try {
                const summaryRes = await fetch(`/api/meta/summary/${practiceCode}?dateFrom=${dateFrom}&dateTo=${dateTo}`);
                const summary = await summaryRes.json();
                
                if (!summary.meta_enabled) {
                    document.getElementById('metaMarketingSection').style.display = 'none';
                    return;
                }
                
                // Get verified leads from database
                try {
                    const leadsRes = await fetch(`/api/leads`);
                    const leadsData = await leadsRes.json();
                    
                    if (Array.isArray(leadsData)) {
                        const metaLeads = leadsData.filter(lead => {
                            if (lead.praktijk_code !== practiceCode) return false;
                            const bron = (lead.bron || '').toLowerCase();
                            return bron === 'facebook' || bron === 'instagram';
                        });
                        summary.verified_leads = metaLeads.length;
                    } else {
                        summary.verified_leads = 0;
                    }
                } catch (leadsError) {
                    console.warn('Could not fetch leads for Meta verification:', leadsError);
                    summary.verified_leads = 0;
                }
                
                document.getElementById('metaMarketingSection').style.display = 'block';
                document.getElementById('metaMarketingNav').style.display = 'block';
                displayMetaSummary(summary);
                
                document.getElementById('metaLastSync').textContent = 
                    `Laatste sync: ${new Date().toLocaleString('nl-NL')}`;
                    
            } catch (error) {
                console.error('Meta marketing error:', error);
                document.getElementById('metaMarketingSection').style.display = 'none';
            }
        }

        function displayMetaSummary(data) {
            document.getElementById('metaTotalSpend').textContent = `â‚¬${parseFloat(data.total_spend || 0).toFixed(2)}`;
            document.getElementById('metaImpressions').textContent = formatNumber(data.total_impressions || 0);
            document.getElementById('metaClicks').textContent = formatNumber(data.total_clicks || 0);
            document.getElementById('metaCTR').textContent = `${parseFloat(data.avg_ctr || 0).toFixed(2)}%`;
            document.getElementById('metaConversions').textContent = data.total_conversions || 0;
            document.getElementById('metaVerifiedLeads').textContent = data.verified_leads || 0;
            document.getElementById('metaCostPerLead').textContent = `â‚¬${parseFloat(data.avg_cost_per_lead || 0).toFixed(2)}`;
            document.getElementById('metaCPC').textContent = `â‚¬${parseFloat(data.avg_cpc || 0).toFixed(2)}`;
            
            const estimatedLeadValue = 150;
            const totalSpend = parseFloat(data.total_spend || 0);
            const totalConversions = parseInt(data.total_conversions || 0);
            const roas = totalSpend > 0 
                ? ((totalConversions * estimatedLeadValue) / totalSpend).toFixed(1)
                : '0.0';
            document.getElementById('metaROAS').textContent = `${roas}x`;
        }

        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        async function openLeadsModal() {
            try {
                const practiceCode = currentUser.role === 'admin' 
                    ? document.getElementById('practiceFilter').value 
                    : currentUser.practice_code;
                
                let url = '/api/leads-by-stage?stage=awareness';
                if (practiceCode) url += `&practice=${practiceCode}`;
                
                const res = await fetch(url);
                const leads = await res.json();
                
                const tbody = document.getElementById('leadsTableBody');
                tbody.innerHTML = leads.map(lead => `
                    <tr>
                        <td>${lead.volledige_naam || '-'}</td>
                        <td>${lead.emailadres || '-'}</td>
                        <td>${lead.telefoon || '-'}</td>
                        <td>${lead.bron || '-'}</td>
                        <td>${new Date(lead.aangemaakt_op).toLocaleDateString('nl-NL')}</td>
                    </tr>
                `).join('');
                
                document.getElementById('leadsModal').classList.add('show');
            } catch (e) {
                console.error('Load leads error:', e);
            }
        }

        async function openBenaderdModal() {
            try {
                const practiceCode = currentUser.role === 'admin' 
                    ? document.getElementById('practiceFilter').value 
                    : currentUser.practice_code;
                
                let url = '/api/leads-by-stage?stage=intent';
                if (practiceCode) url += `&practice=${practiceCode}`;
                
                const res = await fetch(url);
                const leads = await res.json();
                
                const tbody = document.getElementById('benaderdTableBody');
                tbody.innerHTML = leads.map(lead => `
                    <tr>
                        <td>${lead.volledige_naam || '-'}</td>
                        <td>${lead.emailadres || '-'}</td>
                        <td>${lead.telefoon || '-'}</td>
                        <td>${lead.appointment_date || '-'}</td>
                        <td>${new Date(lead.aangemaakt_op).toLocaleDateString('nl-NL')}</td>
                    </tr>
                `).join('');
                
                document.getElementById('benaderdModal').classList.add('show');
            } catch (e) {
                console.error('Load benaderd error:', e);
            }
        }

        function openLidModal() {
            document.getElementById('lidModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function syncMetaData() {
            const practiceCode = currentUser.role === 'admin' 
                ? document.getElementById('practiceFilter').value 
                : currentUser.practice_code;
            
            if (!practiceCode) {
                alert('Selecteer eerst een praktijk');
                return;
            }
            
            try {
                const res = await fetch(`/api/meta/sync/${practiceCode}`, { method: 'POST' });
                const result = await res.json();
                alert('Meta sync succesvol');
                await loadMetaMarketing();
            } catch (e) {
                alert('Meta sync mislukt: ' + e.message);
            }
        }

        function syncEclubData() {
            alert('Eclub sync - nog geen API credentials');
        }

        function exportReport() {
            alert('Rapportage export - nog te implementeren');
        }

        function logout() {
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
                .then(() => window.location.href = '/login.html');
        }

        // Init
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
