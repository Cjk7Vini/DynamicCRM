<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <title>Dynamic CRM ‚Äî Praktijk Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --brand:#2563eb; --ok:#0a7a32; --err:#b91c1c; --ring:rgba(37,99,235,.35);
      --border:#e5e7eb; --soft:#eef2ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:clamp(22px,3vw,30px)}
    .sub{margin:0 0 18px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,.06);margin-bottom:20px}
    .login-box{padding:32px;max-width:480px;margin:60px auto}
    .login-box h2{margin:0 0 8px;font-size:24px}
    .login-box p{margin:0 0 24px;color:var(--muted)}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:14px}
    input[type="password"],input[type="text"]{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:15px
    }
    input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    button{
      width:100%;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer;font-size:15px
    }
    button:hover{filter:brightness(.97)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .msg{margin-top:12px;font-weight:700;padding:10px;border-radius:8px}
    .msg.error{color:var(--err);background:#fef2f2;border:1px solid #fecaca}
    .msg.success{color:var(--ok);background:#f0fdf4;border:1px solid #bbf7d0}
    .dashboard{display:none}
    .dashboard.active{display:block}
    .header{padding:20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fafcff, #f5f7ff)}
    .header-content{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .practice-info h2{margin:0 0 4px;font-size:22px}
    .practice-code{color:var(--muted);font-size:14px}
    .logout-btn{width:auto;padding:8px 16px;font-size:14px;background:#f1f5f9;color:var(--ink)}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;padding:20px}
    .stat-card{background:linear-gradient(135deg,#eef2ff,#e0f2fe);border:1px solid var(--border);border-radius:10px;padding:16px}
    .stat-label{font-size:13px;color:var(--muted);margin-bottom:4px}
    .stat-value{font-size:28px;font-weight:800;color:var(--brand)}
    .toolbar{display:flex;gap:10px;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border);flex-wrap:wrap}
    .toolbar input{min-width:280px;flex:1}
    .results-count{color:var(--muted);font-size:14px;margin-left:auto}
    .tablewrap{overflow:auto;padding:20px}
    table{border-collapse:collapse;width:100%;min-width:880px}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f8fafc;color:#0f172a;font-weight:700;position:sticky;top:0;font-size:13px;text-transform:uppercase;letter-spacing:.5px}
    .pill{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#f1f5f9;font-size:13px}
    .badge{background:#ecfeff;border:1px solid #a5f3fc;color:#164e63;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
    .quiet{color:var(--muted)}
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state-icon{font-size:48px;margin-bottom:16px;opacity:.5}
    .footer{padding:14px 20px;color:var(--muted);font-size:13px;border-top:1px solid var(--border);text-align:center}
    .lock-icon{display:inline-block;margin-right:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Login scherm -->
    <div id="loginScreen">
      <div class="login-box card">
        <h2>üîê Praktijk Dashboard</h2>
        <p>Voer uw praktijkcode en wachtwoord in om uw leads te bekijken.</p>
        
        <form id="loginForm">
          <div class="form-group">
            <label for="practiceCode">Praktijkcode</label>
            <input type="text" id="practiceCode" placeholder="Voer uw praktijkcode in" required autocomplete="username">
          </div>
          
          <div class="form-group">
            <label for="practicePassword">Wachtwoord</label>
            <input type="password" id="practicePassword" placeholder="Voer uw wachtwoord in" required autocomplete="current-password">
          </div>
          
          <button type="submit" id="loginBtn">Inloggen</button>
          <div id="loginMsg" class="msg" style="display:none"></div>
        </form>
      </div>
    </div>

    <!-- Dashboard scherm -->
    <div id="dashboard" class="dashboard">
      <h1>Praktijk Dashboard</h1>
      <p class="sub">Bekijk uw leads en zoek door de gegevens.</p>

      <div class="card">
        <div class="header">
          <div class="header-content">
            <div class="practice-info">
              <h2 id="practiceName">Laden...</h2>
              <div class="practice-code">Code: <strong id="practiceCodeDisplay"></strong></div>
            </div>
            <button class="logout-btn" id="logoutBtn">Uitloggen</button>
          </div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-label">Totaal aantal leads</div>
            <div class="stat-value" id="totalLeads">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Met toestemming</div>
            <div class="stat-value" id="withConsent">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Meest recente</div>
            <div class="stat-value" id="latestDate" style="font-size:16px">-</div>
          </div>
        </div>

        <div class="toolbar">
          <input type="text" id="searchInput" placeholder="Zoek op naam, e-mail, telefoon, bron of doel...">
          <span class="results-count" id="resultsCount">0 resultaten</span>
        </div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Volledige naam</th>
                <th>E-mail</th>
                <th>Telefoon</th>
                <th>Bron</th>
                <th>Doel</th>
                <th>Toestemming</th>
                <th>Aangemaakt</th>
              </tr>
            </thead>
            <tbody id="leadsTable">
              <tr>
                <td colspan="7" class="empty-state">
                  <div class="empty-state-icon">üìä</div>
                  <div>Leads worden geladen...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="footer">
          <span class="lock-icon">üîí</span>
          Alleen-lezen toegang ‚Ä¢ Persoonsgegevens worden conform AVG verwerkt
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let allLeads = [];
    let currentCode = '';
    let authToken = '';

    // Elements
    const loginScreen = document.getElementById('loginScreen');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('loginForm');
    const loginMsg = document.getElementById('loginMsg');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const searchInput = document.getElementById('searchInput');
    const leadsTable = document.getElementById('leadsTable');
    const resultsCount = document.getElementById('resultsCount');
    const totalLeads = document.getElementById('totalLeads');
    const withConsent = document.getElementById('withConsent');
    const latestDate = document.getElementById('latestDate');
    const practiceName = document.getElementById('practiceName');
    const practiceCodeDisplay = document.getElementById('practiceCodeDisplay');

    // Helpers
    const fmtDate = (iso) => {
      try { 
        const d = new Date(iso);
        return d.toLocaleString('nl-NL', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch { return iso || ''; }
    };

    const showMsg = (el, text, type) => {
      el.textContent = text;
      el.className = `msg ${type}`;
      el.style.display = 'block';
    };

    const hideMsg = (el) => {
      el.style.display = 'none';
    };

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMsg(loginMsg);
      
      const code = document.getElementById('practiceCode').value.trim();
      const password = document.getElementById('practicePassword').value;
      
      if (!code || !password) {
        showMsg(loginMsg, 'Vul beide velden in.', 'error');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Bezig met inloggen...';

      try {
        const res = await fetch('/api/practice/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, password })
        });

        const data = await res.json();

        if (!res.ok) {
          showMsg(loginMsg, data.error || 'Inloggen mislukt', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Inloggen';
          return;
        }

        // Success
        currentCode = code;
        authToken = data.token;
        
        // Sla token op in sessionStorage (verdwijnt bij sluiten browser)
        sessionStorage.setItem('practice_token', authToken);
        sessionStorage.setItem('practice_code', currentCode);

        showDashboard();
        await loadLeads();

      } catch (err) {
        showMsg(loginMsg, 'Netwerkfout: ' + err.message, 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Inloggen';
      }
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      sessionStorage.clear();
      currentCode = '';
      authToken = '';
      allLeads = [];
      hideDashboard();
      document.getElementById('practiceCode').value = '';
      document.getElementById('practicePassword').value = '';
      hideMsg(loginMsg);
    });

    // Show/hide screens
    const showDashboard = () => {
      loginScreen.style.display = 'none';
      dashboard.classList.add('active');
    };

    const hideDashboard = () => {
      loginScreen.style.display = 'block';
      dashboard.classList.remove('active');
    };

    // Load leads
    const loadLeads = async () => {
      try {
        const res = await fetch(`/api/practice/leads/${currentCode}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Fout bij ophalen leads');
        }

        allLeads = Array.isArray(data.leads) ? data.leads : [];
        
        // Update practice info
        if (allLeads.length > 0) {
          practiceName.textContent = allLeads[0].praktijk_naam || 'Onbekende praktijk';
        } else {
          practiceName.textContent = 'Uw praktijk';
        }
        practiceCodeDisplay.textContent = currentCode;

        // Update stats
        updateStats();
        renderLeads(allLeads);

      } catch (err) {
        leadsTable.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <div style="color:var(--err)">Fout bij laden: ${err.message}</div>
            </td>
          </tr>
        `;
      }
    };

    // Update statistics
    const updateStats = () => {
      totalLeads.textContent = allLeads.length;
      
      const consent = allLeads.filter(l => l.toestemming).length;
      withConsent.textContent = consent;

      if (allLeads.length > 0) {
        const sorted = [...allLeads].sort((a, b) => 
          new Date(b.aangemaakt_op) - new Date(a.aangemaakt_op)
        );
        const latest = sorted[0].aangemaakt_op;
        latestDate.textContent = fmtDate(latest);
      } else {
        latestDate.textContent = '-';
      }
    };

    // Render leads table
    const renderLeads = (leads) => {
      if (leads.length === 0) {
        leadsTable.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div>Geen leads gevonden</div>
            </td>
          </tr>
        `;
        resultsCount.textContent = '0 resultaten';
        return;
      }

      leadsTable.innerHTML = leads.map(lead => `
        <tr>
          <td>${lead.volledige_naam || '-'}</td>
          <td>${lead.emailadres ? `<span class="pill">${lead.emailadres}</span>` : '<span class="quiet">‚Äì</span>'}</td>
          <td>${lead.telefoon ? `<span class="pill">${lead.telefoon}</span>` : '<span class="quiet">‚Äì</span>'}</td>
          <td>${lead.bron || '-'}</td>
          <td>${lead.doel || '-'}</td>
          <td>${lead.toestemming ? '<span class="badge">Ja</span>' : '<span class="quiet">Nee</span>'}</td>
          <td>${fmtDate(lead.aangemaakt_op)}</td>
        </tr>
      `).join('');

      resultsCount.textContent = `${leads.length} resultaten`;
    };

    // Search functionality
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.trim().toLowerCase();
      
      if (!query) {
        renderLeads(allLeads);
        return;
      }

      const filtered = allLeads.filter(lead => {
        return [
          lead.volledige_naam,
          lead.emailadres,
          lead.telefoon,
          lead.bron,
          lead.doel
        ].some(field => (field || '').toLowerCase().includes(query));
      });

      renderLeads(filtered);
    });

    // Check if already logged in (page refresh)
    window.addEventListener('DOMContentLoaded', () => {
      const savedToken = sessionStorage.getItem('practice_token');
      const savedCode = sessionStorage.getItem('practice_code');

      if (savedToken && savedCode) {
        currentCode = savedCode;
        authToken = savedToken;
        showDashboard();
        loadLeads();
      }
    });
  </script>
</body>
</html>