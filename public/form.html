<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Aanmelden ‚Äì Fysiopraktijk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <style>
    :root{ --bg-gradient:linear-gradient(135deg,#2563eb 0%,#10b981 100%); --card:#fff; --ink:#111827; --muted:#6b7280; --brand:#2563eb; --cta:#f97316; --ok:#0a7a32; --err:#b91c1c; --ring:rgba(37,99,235,.35); }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:var(--bg-gradient);color:var(--ink);min-height:100vh;padding:15px}
    .container{max-width:500px;margin:0 auto}
    .header{color:#fff;text-align:center;margin-bottom:20px;padding:20px 0}
    h1{font-size:clamp(20px,5vw,28px);margin-bottom:10px;line-height:1.3}
    .subtitle{color:#e0f2fe;font-size:14px;line-height:1.5;margin-bottom:15px}
    .bullets{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
    .bullet{background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:20px;padding:6px 12px;font-size:13px;font-weight:500;white-space:nowrap}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 30px rgba(17,24,39,.1);padding:20px}
    label{display:block;margin:15px 0 6px;font-weight:600;font-size:14px;color:var(--ink)}
    input,select,textarea{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:16px;-webkit-appearance:none}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}
    select{background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
    .checkbox-group{display:flex;align-items:flex-start;gap:10px;margin:20px 0}
    input[type="checkbox"]{width:20px;height:20px;margin-top:2px;flex-shrink:0;cursor:pointer}
    .checkbox-label{font-size:14px;color:var(--muted);line-height:1.4;cursor:pointer;user-select:none;-webkit-user-select:none}
    button{width:100%;background:var(--cta);color:#fff;border:0;border-radius:10px;padding:14px 20px;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:20px}
    button:hover{filter:brightness(.9);transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .privacy{margin-top:12px;color:var(--muted);font-size:12px;text-align:center;line-height:1.4}
    #msg{margin-top:15px;padding:12px;border-radius:8px;font-size:14px;text-align:center;font-weight:500}
    #msg.error{background:#fee2e2;color:var(--err);border:1px solid #fecaca}
    #msg.success{background:#dcfce7;color:var(--ok);border:1px solid #86efac}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Plan je eerste afspraak ‚Äì we helpen je snel weer vrij te bewegen</h1>
      <p class="subtitle">Laat je gegevens achter en we nemen <strong>binnen √©√©n werkdag</strong> contact met je op.</p>
      <div class="bullets">
        <div class="bullet">‚úÖ Persoonlijk plan</div>
        <div class="bullet">‚è±Ô∏è Snel ingepland</div>
        <div class="bullet">üõ°Ô∏è AVG-proof</div>
      </div>
    </div>

    <form id="leadForm" class="card" novalidate method="post" action="/leads">
      <input type="hidden" name="praktijk_code" id="praktijk_code" />
      <input type="hidden" name="utm_source" id="utm_source" />
      <input type="hidden" name="utm_medium" id="utm_medium" />
      <input type="hidden" name="utm_campaign" id="utm_campaign" />

      <label for="volledige_naam">Volledige naam</label>
      <input type="text" id="volledige_naam" name="volledige_naam" placeholder="Voor- en achternaam" required autocomplete="name" />

      <label for="telefoon">Telefoon</label>
      <input type="tel" id="telefoon" name="telefoon" placeholder="06 12345678" autocomplete="tel" />

      <label for="emailadres">Emailadres</label>
      <input type="email" id="emailadres" name="emailadres" placeholder="jij@example.com" autocomplete="email" />

      <label for="bron">Waar ken je ons van?</label>
      <select id="bron" name="bron">
        <option value="">(kies)</option>
        <option value="Website">Website</option>
        <option value="Instagram">Instagram</option>
        <option value="LinkedIn">LinkedIn</option>
        <option value="YouTube">YouTube</option>
        <option value="Referral">Doorverwijzing</option>
      </select>

      <label for="doel">Wat is je doel of klacht?</label>
      <input type="text" id="doel" name="doel" placeholder="Bijv. rugpijn, sterker worden..." />

      <div class="checkbox-group" id="consentWrap">
        <input type="checkbox" id="toestemming" name="toestemming" required />
        <label for="toestemming" class="checkbox-label">
          Ik geef toestemming om mijn gegevens te verwerken voor het maken van een afspraak
        </label>
      </div>

      <button type="submit">Gratis afspraak aanvragen</button>

      <p class="privacy">We gebruiken je gegevens alleen om je aanmelding te behandelen. Geen spam, geen verkoop aan derden.</p>
      <div id="msg"></div>
    </form>
  </div>

  <script>
    const form = document.getElementById('leadForm');
    const msg = document.getElementById('msg');
    const praktijkInput = document.getElementById('praktijk_code');
    const utmSource = document.getElementById('utm_source');
    const utmMedium = document.getElementById('utm_medium');
    const utmCampaign = document.getElementById('utm_campaign');
    const toestemmingCheckbox = document.getElementById('toestemming');

    // Helpers
    function getParam(name){ return new URLSearchParams(location.search).get(name) || ''; }
    function detectSource(){
      const utm = getParam('utm_source'); const ref = document.referrer || '';
      if(utm) return utm;
      if(ref.includes('instagram.com')) return 'Instagram';
      if(ref.includes('youtube.com')) return 'YouTube';
      if(ref.includes('facebook.com')) return 'Facebook';
      if(ref.includes('linkedin.com')) return 'LinkedIn';
      if(ref.includes('google.com')) return 'Google';
      return 'Direct';
    }

    // Hidden velden
    praktijkInput.value = getParam('s') || getParam('praktijk') || getParam('p') || '';
    utmSource.value = getParam('utm_source') || detectSource();
    utmMedium.value = getParam('utm_medium') || 'organic';
    utmCampaign.value = getParam('utm_campaign') || '';

    // Pageview ‚Üí /events
    if (praktijkInput.value && navigator.sendBeacon) {
      const payload = { practice_code: praktijkInput.value, event_type: 'clicked', metadata: { source: detectSource() } };
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      navigator.sendBeacon('/events', blob);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = ''; msg.className = '';

      // Native required vangt de meeste gevallen al af
      if (!toestemmingCheckbox.checked) {
        msg.textContent = 'U moet toestemming geven voor het verwerken van uw gegevens.';
        msg.className = 'error';
        document.getElementById('consentWrap').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true; submitBtn.textContent = 'Bezig met versturen‚Ä¶';

      const data = {
        volledige_naam: document.getElementById('volledige_naam').value.trim(),
        emailadres: document.getElementById('emailadres').value.trim() || null,
        telefoon: document.getElementById('telefoon').value.trim() || null,
        bron: document.getElementById('bron').value || detectSource(),
        doel: document.getElementById('doel').value.trim() || null,
        toestemming: true,
        praktijk_code: praktijkInput.value || null,
        // de utm_* sturen we mee maar de server negeert ze bij INSERT (ok)
        utm_source: utmSource.value,
        utm_medium: utmMedium.value,
        utm_campaign: utmCampaign.value
      };

      try{
        const res = await fetch('/leads', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json().catch(()=> ({}));

        if(!res.ok){
          msg.textContent = (result?.details?.join(', ') || result?.error || 'Er ging iets mis.') + ' Probeer het opnieuw.';
          msg.className = 'error';
          return;
        }

        msg.textContent = '‚úÖ Bedankt! Je aanmelding is verstuurd. We nemen binnen 1 werkdag contact op.';
        msg.className = 'success';

        if (praktijkInput.value && navigator.sendBeacon) {
          const payload = {
            lead_id: result?.lead?.id || null,
            practice_code: praktijkInput.value,
            event_type: 'lead_submitted',
            metadata: { bron: data.bron }
          };
          const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
          navigator.sendBeacon('/events', blob);
        }

        setTimeout(()=>{ form.reset(); }, 1500);
      } catch(err){
        msg.textContent = 'Er ging iets mis. Controleer je internet en probeer opnieuw.';
        msg.className = 'error';
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Gratis afspraak aanvragen';
      }
    });
  </script>
</body>
</html>
