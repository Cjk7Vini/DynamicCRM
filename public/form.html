<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <title>Aanmelden – Fysiopraktijk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <style>
    :root{
      --bg-gradient: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
      --card:#ffffff; --ink:#111827; --muted:#6b7280; --brand:#2563eb; --cta:#f97316;
      --ok:#0a7a32; --err:#b91c1c; --ring: rgba(37,99,235,.35);
    }
    *{ box-sizing:border-box; margin:0; padding:0 }
    body{ font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; background:var(--bg-gradient); color:var(--ink); min-height:100vh; padding:15px }
    .container{ max-width:500px; margin:0 auto }
    .header{ color:#fff; text-align:center; margin-bottom:20px; padding:20px 0 }
    h1{ font-size:clamp(20px,5vw,28px); margin-bottom:10px; line-height:1.3 }
    .subtitle{ color:#e0f2fe; font-size:14px; line-height:1.5; margin-bottom:15px }
    .bullets{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:20px }
    .bullet{ background:rgba(255,255,255,.15); color:#fff; border:1px solid rgba(255,255,255,.25); border-radius:20px; padding:6px 12px; font-size:13px; font-weight:500; white-space:nowrap }
    .card{ background:var(--card); border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 30px rgba(17,24,39,.1); padding:20px }
    label{ display:block; margin:15px 0 6px; font-weight:600; font-size:14px }
    input,select,textarea{ width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; background:#fff; font-size:16px; -webkit-appearance:none }
    input:focus,select:focus,textarea:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px var(--ring) }
    select{ background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236B7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:32px }
    .checkbox-group{ display:flex; align-items:flex-start; gap:12px; margin:20px 0; padding:12px; border-radius:8px; transition:all 0.2s }
    .checkbox-group.error{ background:#fee2e2; border:2px solid var(--err) }
    
    /* Custom checkbox styling */
    input[type="checkbox"]{ 
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    
    .checkbox-wrapper {
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
    }
    
    .custom-checkbox {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      margin-top: 2px;
    }
    
    .custom-checkbox:hover {
      border-color: var(--brand);
    }
    
    input[type="checkbox"]:checked + .custom-checkbox {
      background: var(--brand);
      border-color: var(--brand);
    }
    
    input[type="checkbox"]:checked + .custom-checkbox::after {
      content: '✓';
      color: white;
      font-size: 16px;
      font-weight: bold;
    }
    
    input[type="checkbox"]:focus + .custom-checkbox {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
    }
    
    .checkbox-label{ font-size:14px; color:var(--ink); line-height:1.5; cursor:pointer; flex:1 }
    button{ width:100%; background:var(--cta); color:#fff; border:0; border-radius:10px; padding:14px 20px; font-size:16px; font-weight:700; cursor:pointer; transition:all .2s; margin-top:20px }
    button:hover{ filter:brightness(.9); transform:translateY(-1px) }
    button:active{ transform:translateY(0) }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .privacy{ margin-top:12px; color:var(--muted); font-size:12px; text-align:center; line-height:1.4 }
    #msg{ margin-top:15px; padding:12px; border-radius:8px; font-size:14px; text-align:center; font-weight:500 }
    #msg.error{ background:#fee2e2; color:var(--err); border:1px solid #fecaca }
    #msg.success{ background:#dcfce7; color:var(--ok); border:1px solid #86efac }
    @media (max-width:480px){ body{padding:10px} .card{padding:15px} h1{font-size:22px} .bullets{flex-direction:column; align-items:center} .bullet{width:100%; max-width:250px; text-align:center} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Plan je eerste afspraak</h1>
      <h2 style="font-size:20px;font-weight:600;margin:16px 0 8px 0;color:#fff;">Ontdek hoe goed bewegen écht voelt</h2>
      <p style="font-size:15px;font-weight:500;margin-bottom:12px;color:#e0f2fe;">Plan jouw gratis vitaliteitscheck of rondleiding</p>
      <p class="subtitle" style="max-width:450px;margin:0 auto 20px;">
        Bij onze praktijk geloven we dat iedereen, ongeacht leeftijd of klachten, zich fitter, sterker en energieker kan voelen. 
        Onze oefenruimte is ingericht om jou te laten bewegen met plezier én zichtbaar resultaat.
      </p>
      <div class="bullets">
        <div class="bullet">✅ Persoonlijk plan</div>
        <div class="bullet">⏱️ Snel ingepland</div>
      </div>
    </div>

    <form id="leadForm" class="card" novalidate method="post" action="/leads">
      <input type="hidden" name="praktijk_code" id="praktijk_code" />
      <input type="hidden" name="utm_source" id="utm_source" />
      <input type="hidden" name="utm_medium" id="utm_medium" />
      <input type="hidden" name="utm_campaign" id="utm_campaign" />
      
      <label for="volledige_naam">Volledige naam</label>
      <input type="text" id="volledige_naam" name="volledige_naam" placeholder="Voor- en achternaam" required autocomplete="name" />
      
      <label for="telefoon">Telefoon</label>
      <input type="tel" id="telefoon" name="telefoon" placeholder="06 12345678" autocomplete="tel" />
      
      <label for="emailadres">Emailadres</label>
      <input type="email" id="emailadres" name="emailadres" placeholder="jij@example.com" autocomplete="email" />
      
      <label for="bron">Waar ken je ons van?</label>
      <select id="bron" name="bron">
        <option value="">(kies)</option>
        <option value="Voucher">Voucher</option>
        <option value="Facebook">Facebook</option>
        <option value="Instagram">Instagram</option>
        <option value="LinkedIn">LinkedIn</option>
      </select>
      
      <label for="doel">Wat is je doel?</label>
      <select id="doel" name="doel">
        <option value="">(kies je doel)</option>
        <option value="Mobiliteit verbeteren">Mobiliteit verbeteren</option>
        <option value="Gewicht verliezen">Gewicht verliezen</option>
        <option value="Fitter worden">Fitter worden</option>
        <option value="Conditie verbeteren">Conditie verbeteren</option>
        <option value="Klachten voorkomen">Klachten voorkomen</option>
        <option value="Fitheid behouden">Fitheid behouden</option>
      </select>
      
      <div class="checkbox-group" id="toestemming-group">
        <div class="checkbox-wrapper">
          <input type="checkbox" id="toestemming" name="toestemming" />
          <label for="toestemming" class="custom-checkbox"></label>
          <label for="toestemming" class="checkbox-label">
            Ik geef toestemming om mijn gegevens te verwerken voor het maken van een afspraak
          </label>
        </div>
      </div>
      
      <button type="submit">Gratis afspraak aanvragen</button>
      <p class="privacy">We gebruiken je gegevens alleen om je aanmelding te behandelen. Geen spam, geen verkoop aan derden.</p>
      <div id="msg"></div>
    </form>
  </div>

  <script>
    const form = document.getElementById('leadForm');
    const msg = document.getElementById('msg');
    const praktijkInput = document.getElementById('praktijk_code');
    const utmSource = document.getElementById('utm_source');
    const utmMedium = document.getElementById('utm_medium');
    const utmCampaign = document.getElementById('utm_campaign');
    const toestemmingCheckbox = document.getElementById('toestemming');
    const toestemmingGroup = document.getElementById('toestemming-group');

    function getParam(n){ return new URLSearchParams(location.search).get(n) || ''; }
    function detectSource(){
      const utm = getParam('utm_source'); const ref = document.referrer || '';
      if(utm) return utm;
      if(ref.includes('instagram.com')) return 'Instagram';
      if(ref.includes('youtube.com')) return 'YouTube';
      if(ref.includes('facebook.com')) return 'Facebook';
      if(ref.includes('linkedin.com')) return 'LinkedIn';
      if(ref.includes('google.com')) return 'Google';
      return 'Direct';
    }
    praktijkInput.value = getParam('s') || getParam('praktijk') || getParam('p') || '';
    utmSource.value = getParam('utm_source') || detectSource();
    utmMedium.value = getParam('utm_medium') || 'organic';
    utmCampaign.value = getParam('utm_campaign') || '';

    if (praktijkInput.value && navigator.sendBeacon) {
      const payload = { practice_code: praktijkInput.value, event_type: 'clicked', metadata: { source: utmSource.value } };
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      navigator.sendBeacon('/events', blob);
    }

    // Remove error styling when checkbox is checked
    toestemmingCheckbox.addEventListener('change', () => {
      if (toestemmingCheckbox.checked) {
        toestemmingGroup.classList.remove('error');
        msg.textContent = '';
        msg.className = '';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent=''; msg.className='';
      toestemmingGroup.classList.remove('error');
      
      // VALIDATIE: Check of toestemming is gegeven
      if (!toestemmingCheckbox.checked) {
        toestemmingGroup.classList.add('error');
        msg.textContent = '⚠️ Je moet toestemming geven om je gegevens te verwerken voordat je kunt doorgaan.';
        msg.className = 'error';
        toestemmingCheckbox.focus();
        return;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true; submitBtn.textContent = 'Bezig met versturen…';

      const data = {
        volledige_naam: document.getElementById('volledige_naam').value.trim(),
        emailadres: document.getElementById('emailadres').value.trim() || null,
        telefoon: document.getElementById('telefoon').value.trim() || null,
        bron: document.getElementById('bron').value || utmSource.value,
        doel: document.getElementById('doel').value.trim() || null,
        toestemming: true, // We weten nu zeker dat het checked is
        praktijk_code: praktijkInput.value || null,
        utm_source: utmSource.value,
        utm_medium: utmMedium.value,
        utm_campaign: utmCampaign.value
      };

      try{
        const res = await fetch('/leads', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
        const result = await res.json().catch(()=> ({}));
        if(!res.ok){
          msg.textContent = (result?.details?.join(', ') || result?.error || 'Er ging iets mis.') + ' Probeer het opnieuw.';
          msg.className = 'error';
        }else{
          msg.textContent = '✅ Bedankt! Je aanmelding is verstuurd. We nemen binnen 1 werkdag contact op.';
          msg.className = 'success';
          if (praktijkInput.value && navigator.sendBeacon) {
            const payload = { lead_id: result?.lead?.id || null, practice_code: praktijkInput.value, event_type: 'lead_submitted', metadata: { bron: data.bron } };
            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
            navigator.sendBeacon('/events', blob);
          }
          setTimeout(()=> form.reset(), 1200);
        }
      }catch(err){
        msg.textContent = 'Er ging iets mis. Controleer je internet en probeer opnieuw.'; msg.className='error';
      }finally{
        submitBtn.disabled = false; submitBtn.textContent = 'Gratis afspraak aanvragen';
      }
    });
  </script>
</body>
</html>