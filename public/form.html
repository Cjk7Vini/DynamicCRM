// public/js/form.js
(function () {
  const form   = document.getElementById('leadForm');
  if (!form) return;

  const msg    = document.getElementById('msg');
  const hidden = document.getElementById('praktijk_code');
  const tsEl   = document.getElementById('_ts');
  const hpEl   = document.getElementById('_hp');

  const errNaam = document.getElementById('err_naam');
  const errTel  = document.getElementById('err_tel');
  const errMail = document.getElementById('err_mail');

  const MIN_SUBMIT_MS = 1500;

  function normalizeCode(raw){
    if(!raw) return '';
    return String(raw).trim().replace(/[^A-Za-z0-9_-]/g,'');
  }

  // praktijk_code uit URL
  try{
    const p   = new URLSearchParams(location.search);
    const raw = p.get('s') || p.get('praktijk') || '';
    const code = normalizeCode(raw);
    if(code) hidden.value = code;
  }catch(_){}

  // timestamp voor time-to-submit
  function resetTimestamp(){ tsEl.value = String(Date.now()); }
  resetTimestamp();

  // simpele disposable domeinen lijst (client-side deterrent)
  const DISPOSABLE = new Set([
    'mailinator.com','yopmail.com','guerrillamail.com','10minutemail.com','temp-mail.org',
    'fakeinbox.com','getnada.com','trashmail.com','dispostable.com','sharklasers.com'
  ]);

  function showError(el, text){
    if(!el) return;
    el.textContent = text || '';
    el.hidden = !text;
  }

  function clearErrors(){
    showError(errNaam, ''); showError(errTel,''); showError(errMail,'');
    if (msg){ msg.textContent=''; msg.className=''; }
  }

  function atLeastOneContact(email, tel){
    return !!email || !!tel;
  }

  form.addEventListener('submit', async (e) => {
    // Alleen JS-pad gebruiken als JS werkt
    e.preventDefault();
    clearErrors();

    const code = normalizeCode(hidden.value);
    const naam = form.volledige_naam.value.trim();
    const mail = form.emailadres.value.trim().toLowerCase();
    const tel  = form.telefoon.value.trim();

    // Honeypot
    if (hpEl && hpEl.value) {
      if (msg){ msg.textContent = 'Fout: ongeldige invoer.'; msg.className = 'error'; }
      return;
    }

    // Time-to-submit
    const age = Date.now() - Number(tsEl.value || 0);
    if (age < MIN_SUBMIT_MS) {
      if (msg){ msg.textContent = 'Te snel verstuurd. Probeer het nog eens.'; msg.className = 'error'; }
      return;
    }

    // Naam
    if (!/^[\p{L}][\p{L}\p{M}\-\' ]{1,98}$/u.test(naam)) {
      showError(errNaam, 'Vul je volledige naam in (alleen letters, spaties, - en ’).');
      return;
    }

    // Minstens één contact
    if (!atLeastOneContact(mail, tel)) {
      showError(errMail, 'Vul e-mail of telefoon in (minstens één).');
      showError(errTel,  'Vul e-mail of telefoon in (minstens één).');
      return;
    }

    // Telefoon
    if (tel && !/^[0-9+\-() ]{8,20}$/.test(tel)) {
      showError(errTel, 'Ongeldig telefoonnummer.');
      return;
    }

    // Email
    if (mail) {
      const basic = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(mail);
      if (!basic) {
        showError(errMail, 'Ongeldig e-mailadres.');
        return;
      }
      const domain = mail.split('@')[1];
      if (DISPOSABLE.has(domain)) {
        showError(errMail, 'Gebruik een echt e-mailadres (wegwerp niet toegestaan).');
        return;
      }
    }

    // Toestemming
    if (!form.toestemming.checked) {
      if (msg){ msg.textContent = 'Geef toestemming om je gegevens te verwerken.'; msg.className = 'error'; }
      return;
    }

    // Payload
    const data = {
      volledige_naam: naam,
      emailadres:     mail || null,
      telefoon:       tel  || null,
      bron:           form.bron.value || null,
      doel:           form.doel.value.trim() || null,
      toestemming:    form.toestemming.checked,
      praktijk_code:  code || null,
      _ts:            Number(tsEl.value),
      _hp:            '' // hoort leeg te zijn
    };

    try{
      const res  = await fetch('/leads', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json().catch(()=>({}));

      if(!res.ok){
        if (msg){ msg.textContent = 'Fout: ' + (json.error || res.statusText); msg.className = 'error'; }
        console.error('Server detail:', json.details);
        return;
      }

      if (msg){ msg.textContent = 'Bedankt! Je aanmelding is verstuurd. We nemen snel contact op.'; msg.className = 'success'; }

      form.reset();
      hidden.value = code; // code behouden
      resetTimestamp();
    }catch(err){
      if (msg){ msg.textContent = 'Kon niet opslaan: ' + err.message; msg.className = 'error'; }
    }
  });
})();
